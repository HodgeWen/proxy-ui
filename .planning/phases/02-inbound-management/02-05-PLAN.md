---
phase: 02-inbound-management
plan: 05
type: execute
wave: 4
depends_on: ["02-03"]
files_modified:
  - web/src/components/inbounds/InboundFormModal.tsx
  - web/src/pages/Inbounds.tsx
  - web/package.json
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can add VLESS and Hysteria2 via form modal"
    - "Form has protocol select, sections 基本设置/TLS/传输, TLS dropdown (VLESS: 无/TLS/Reality; Hysteria2: TLS only)"
    - "Transport radio: TCP/WebSocket/gRPC/HTTP/2"
    - "Check error displayed in Modal top, form stays open"
    - "每个字段旁有 info 图标悬浮说明"
  artifacts:
    - path: web/src/components/inbounds/InboundFormModal.tsx
      provides: Add/Edit form modal
      contains: "react-hook-form|useForm"
  key_links:
    - from: web/src/components/inbounds/InboundFormModal.tsx
      to: /api/inbounds
      via: fetch POST/PUT
      pattern: "api/inbounds|fetch.*POST|fetch.*PUT"
---

<objective>
Implement InboundFormModal for add/edit VLESS and Hysteria2. Unified form with protocol select, sections, TLS and transport options. react-hook-form + zod, smart defaults, info tooltips. Check error in Modal top per CONTEXT.

Purpose: Per CONTEXT — 统一表单, 分段显示, 宽 Modal, check 失败不关闭弹框.
Output: InboundFormModal.tsx, wired to Inbounds page
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-inbound-management/02-RESEARCH.md
@.planning/phases/02-inbound-management/02-CONTEXT.md
@web/src/pages/Dashboard.tsx
@web/src/components/ui/dialog.tsx
@web/src/components/ui/tooltip.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Form shell and dependencies</name>
  <files>web/package.json, web/src/components/inbounds/InboundFormModal.tsx</files>
  <action>
Install: cd web && bun add react-hook-form @hookform/resolvers zod
bunx shadcn@latest add select label radio-group

Create InboundFormModal.tsx:
- Props: open, onOpenChange, inbound (optional, for edit), onSuccess callback
- DialogContent: max-w-3xl or max-w-4xl, max-h-[90vh] overflow-y-auto per CONTEXT
- Section headers: 基本设置, TLS, 传输
- Protocol select (VLESS | Hysteria2) — controls which fields show
- 基本设置: tag, listen (default "::"), listen_port
- Use react-hook-form with useForm, zodResolver. Schema: tag (string, min 1), listen (string), listen_port (number, 1-65535)
- Conditionally show TLS and 传输 sections based on protocol
- At top of form: {checkError && <div className="rounded-lg bg-destructive/10 text-destructive p-3 text-sm"><pre>{checkError}</pre></div>} — per CONTEXT: check error in Modal top, do not close
- Submit button, Cancel button
</action>
  <verify>cd web && bun run build</verify>
  <done>Form modal renders with protocol select, basic fields, check error area</done>
</task>

<task type="auto">
  <name>Task 2: TLS and transport fields</name>
  <files>web/src/components/inbounds/InboundFormModal.tsx</files>
  <action>
TLS section (per CONTEXT):
- VLESS: Select 无 TLS | TLS | Reality. When TLS: server_name, certificate_path, key_path. When Reality: handshake.server, handshake.server_port, private_key, short_id (Reality fields per RESEARCH)
- Hysteria2: TLS only (no "无 TLS", no Reality). server_name, certificate_path, key_path

Transport section (VLESS only; Hysteria2 uses QUIC, no transport):
- RadioGroup: TCP | WebSocket | gRPC | HTTP/2
- When WebSocket: path (default "/vless")
- When gRPC: service_name (default "TunService")
- When HTTP/2: host, path

Hysteria2-specific (in 基本设置 or separate section): up_mbps, down_mbps (number), obfs password (optional). Smart defaults: up_mbps 100, down_mbps 100.

Add zod schema for all fields. Validation on blur (mode: "onBlur" in useForm).
</action>
  <verify>cd web && bun run build</verify>
  <done>TLS and transport fields conditional on protocol; VLESS Reality fields when TLS=Reality</done>
</task>

<task type="auto">
  <name>Task 3: Smart defaults, info tooltips, submit flow</name>
  <files>web/src/components/inbounds/InboundFormModal.tsx, web/src/pages/Inbounds.tsx</files>
  <action>
Smart defaults (per CONTEXT):
- VLESS: tag default "vless-in-1" (or next available), listen "::", listen_port 443, flow "xtls-rprx-vision" if TLS
- Hysteria2: tag "hy2-in-1", listen "::", listen_port 443, up_mbps 100, down_mbps 100

Info tooltips: Each field label + Info icon (lucide-react) with Tooltip. Content: 字段说明 + 典型值 + 何时需要修改. Use existing Tooltip from web/src/components/ui/tooltip.tsx.

Submit flow:
- Build request body from form values (config_json structure matching API/ConfigGenerator)
- POST /api/inbounds (create) or PUT /api/inbounds/:id (edit)
- On 400: parse error, setCheckError(body.error), do NOT close modal
- On 2xx: toast.success, onSuccess(), onOpenChange(false)
- Invalidate queryKey ["inbounds"]

Wire Inbounds page: "添加入站" opens InboundFormModal (open state). Edit button in table calls same modal with inbound prop for edit. Pass onSuccess to invalidate query.

Delete flow: Inbounds page implements onDelete(id). Use AlertDialog or window.confirm for confirmation. DELETE /api/inbounds/:id. On success: invalidate ["inbounds"], toast.success. On 400: toast.error with message.
</action>
  <verify>cd web && bun run build; add VLESS flow creates inbound, applies config</verify>
  <done>Add/Edit works; check error in Modal; success toast; info tooltips on fields</done>
</task>

</tasks>

<verification>
- cd web && bun run build
- Add VLESS: form submit -> POST -> config applied -> list refreshed
- Invalid config: 400 returned, error shown in Modal top, form stays open
</verification>

<success_criteria>
- Add VLESS and Hysteria2 via modal
- Edit and Delete wired from list
- Check error in Modal, smart defaults, info tooltips
</success_criteria>

<output>
After completion, create `.planning/phases/02-inbound-management/02-05-SUMMARY.md`
</output>
