---
phase: 02-inbound-management
plan: 03
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - internal/api/inbounds.go
  - internal/api/routes.go
autonomous: true
user_setup: []

must_haves:
  truths:
    - "API returns inbound list at GET /api/inbounds"
    - "Create/Update/Delete trigger ConfigGenerator, ApplyConfig, Restart"
    - "Check failure returns error in response, does not close client Modal"
  artifacts:
    - path: internal/api/inbounds.go
      provides: List, Create, Update, Delete handlers
      exports: ["ListInboundsHandler", "CreateInboundHandler", "UpdateInboundHandler", "DeleteInboundHandler"]
    - path: internal/api/routes.go
      provides: /api/inbounds routes with RequireAuth
      contains: "/inbounds"
  key_links:
    - from: internal/api/inbounds.go
      to: internal/core/generator.go
      via: ConfigGenerator.Generate
      pattern: "Generate|ApplyConfig"
    - from: internal/api/inbounds.go
      to: internal/core/config.go
      via: core.ApplyConfig
      pattern: "ApplyConfig"
---

<objective>
Implement Inbound REST API: GET list, POST create, PUT update, DELETE. Create/Update/Delete persist to DB, regenerate config, run sing-box check, apply and restart on success; return check error on failure.

Purpose: Frontend uses these endpoints for CRUD. Per CONTEXT: check failure returns error to Modal (does not close).
Output: internal/api/inbounds.go, routes.go updated
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-inbound-management/02-RESEARCH.md
@.planning/phases/02-inbound-management/02-CONTEXT.md
@internal/api/core.go
@internal/api/routes.go
@internal/core/config.go
@internal/core/process.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: List and Get handlers</name>
  <files>internal/api/inbounds.go, internal/api/routes.go</files>
  <action>
Create internal/api/inbounds.go.

ListInboundsHandler(sm): GET /api/inbounds — db.ListInbounds(), return JSON {"data": [...]}. Each item: id, tag, protocol, listen, listen_port, tls_type (none|tls|reality), transport_type (tcp|ws|grpc|http), user_count (0 for Phase 2), created_at. Derive tls_type and transport_type from config_json.

GetInboundHandler(sm): GET /api/inbounds/:id — db.GetInboundByID, return single object or 404.

Add routes in routes.go under /api with RequireAuth:
  r.Route("/inbounds", func(r chi.Router) {
    r.Use(RequireAuth(sm))
    r.Get("/", ListInboundsHandler(sm))
    r.Get("/{id}", GetInboundHandler(sm))  // chi.URLParam for id
  })

Use configPath() pattern from core.go (SINGBOX_CONFIG_PATH).
</action>
  <verify>go build ./... && curl -s -b cookies.txt http://localhost:8080/api/inbounds returns JSON</verify>
  <done>GET /api/inbounds returns list; GET /api/inbounds/1 returns single or 404</done>
</task>

<task type="auto">
  <name>Task 2: Create, Update, Delete with config apply flow</name>
  <files>internal/api/inbounds.go, internal/api/routes.go</files>
  <action>
Add handlers:

CreateInboundHandler: POST /api/inbounds — decode JSON body into Inbound (tag, protocol, listen, listen_port, config_json). Validate tag unique. db.CreateInbound. Then: generator.Generate() -> core.ApplyConfig(path, json). If ApplyConfig fails: db.DeleteInbound (rollback), return 400 with {"error": err.Error()} (check output in error). If success: core.NewProcessManager().Restart(path), return 201 with created object.

UpdateInboundHandler: PUT /api/inbounds/:id — decode body, set ID from URL. db.UpdateInbound. Same apply flow: Generate -> ApplyConfig. On failure: revert via db.UpdateInbound with old data (or fetch-before-save pattern). Return 200 or 400 with error.

DeleteInboundHandler: DELETE /api/inbounds/:id — db.DeleteInbound. Generate -> ApplyConfig -> Restart. On ApplyConfig failure return 400 with error (config may be invalid without this inbound).

Add routes: r.Post("/", ...), r.Put("/{id}", ...), r.Delete("/{id}", ...).

Use chi.URLParam(r, "id") for id. Parse id as uint.
</action>
  <verify>go build ./...; POST /api/inbounds with valid body creates and restarts; invalid config returns 400 with error message</verify>
  <done>Create/Update/Delete persist to DB, apply config, restart on success; return check error on failure</done>
</task>

</tasks>

<verification>
- go build ./...
- GET /api/inbounds returns 200 with data array
- POST with valid VLESS creates inbound, applies config, sing-box restarts
- POST with invalid config returns 400, error contains check output
</verification>

<success_criteria>
- Full CRUD API for inbounds
- Config apply + restart on mutate; check error returned to frontend
</success_criteria>

<output>
After completion, create `.planning/phases/02-inbound-management/02-03-SUMMARY.md`
</output>
