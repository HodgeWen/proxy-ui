---
phase: 08-deployment-production
plan: 04
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - .github/workflows/release.yml
  - Makefile
autonomous: true

must_haves:
  truths:
    - "Push tag v* triggers GitHub Actions build and release"
    - "Release contains s-ui-linux-amd64 and s-ui-linux-arm64"
    - "Local make build-release produces same artifacts"
  artifacts:
    - path: .github/workflows/release.yml
      provides: "CI on tag push"
      contains: "on:.*push.*tags|action-gh-release"
    - path: Makefile
      provides: "build-release target"
      contains: "build-release|GOOS=linux"
  key_links:
    - from: .github/workflows/release.yml
      to: web/dist
      via: "bun run build before go build"
      pattern: "bun run build|go build"
---

<objective>
Add GitHub Actions workflow for release on tag push; build linux/amd64 and linux/arm64; upload to GitHub Release.

Purpose: SYS-05 — 单二进制发布 per CONTEXT.
Output: .github/workflows/release.yml, Makefile build-release
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-deployment-production/08-CONTEXT.md
@.planning/phases/08-deployment-production/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: GitHub Actions release workflow</name>
  <files>.github/workflows/release.yml</files>
  <action>
Create .github/workflows/release.yml per RESEARCH:

on:
  push:
    tags: ['v*']

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Build frontend
        run: cd web && bun install --frozen-lockfile && bun run build
      - name: Build
        run: |
          for arch in amd64 arm64; do
            CGO_ENABLED=0 GOOS=linux GOARCH=$arch go build -ldflags="-s -w" -o s-ui-linux-$arch ./cmd/server
          done
      - uses: softprops/action-gh-release@v2
        with:
          files: s-ui-linux-amd64 s-ui-linux-arm64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

CRITICAL: Build frontend FIRST (embed dist). Then go build for both arches. Use CGO_ENABLED=0 so cross-compilation to arm64 succeeds (requires 08-01 pure-Go SQLite migration). Output: s-ui-linux-amd64, s-ui-linux-arm64 per CONTEXT naming.
</action>
  <verify>Workflow file valid (yamllint or gh workflow list); local simulation: make build-release produces s-ui-linux-amd64 and s-ui-linux-arm64; both binaries run (CGO_ENABLED=0 cross-compile works after 08-01)</verify>
  <done>Tag push triggers build; artifacts uploaded to release</done>
</task>

<task type="auto">
  <name>Task 2: Makefile build-release target</name>
  <files>Makefile</files>
  <action>
Add to Makefile:

build-release: build-frontend
	CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o s-ui-linux-amd64 $(BACKEND_ENTRY)
	CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o s-ui-linux-arm64 $(BACKEND_ENTRY)

.PHONY: build-release

Ensure build-frontend runs first (embed requires dist). Use CGO_ENABLED=0 for cross-compilation (requires 08-01 pure-Go SQLite). Use BACKEND_ENTRY from existing Makefile (./cmd/server).
</action>
  <verify>make build-release produces s-ui-linux-amd64 and s-ui-linux-arm64; ./s-ui-linux-amd64 --help or run briefly to confirm binary works</verify>
  <done>Local build-release produces release artifacts</done>
</task>

</tasks>

<verification>
- make build-release succeeds
- s-ui-linux-amd64 and s-ui-linux-arm64 run (or at least execute)
- .github/workflows/release.yml valid
</verification>

<success_criteria>
- Push tag v1.0.0 triggers GitHub Actions
- Release contains linux amd64 and arm64 binaries
- make build-release for local testing
</success_criteria>

<output>
After completion, create `.planning/phases/08-deployment-production/08-04-SUMMARY.md`
</output>
