---
phase: 08-deployment-production
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - Dockerfile
  - docker-compose.yml
  - docker-entrypoint.sh
autonomous: true

must_haves:
  truths:
    - "docker compose up -d runs s-ui + sing-box in single container"
    - "Data persists via bind mount to host directory"
    - "Config mounted as config.json; panel and sing-box work"
  artifacts:
    - path: Dockerfile
      provides: "Multi-stage build with s-ui + sing-box"
      contains: "FROM|COPY|RUN"
    - path: docker-compose.yml
      provides: "One-command deploy"
      contains: "volumes:|ports:"
  key_links:
    - from: docker-compose.yml
      to: Dockerfile
      via: "build context"
      pattern: "build:|image:"
    - from: Dockerfile
      to: "sing-box"
      via: "download from GitHub releases at build time"
      pattern: "sing-box|SagerNet"
---

<objective>
Add Dockerfile and docker-compose.yml for single-container deployment (s-ui + sing-box), bind mount data and config.

Purpose: SYS-03 — Docker Compose 一条命令部署 per CONTEXT.
Output: Dockerfile, docker-compose.yml, docker-entrypoint.sh
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-deployment-production/08-CONTEXT.md
@.planning/phases/08-deployment-production/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Multi-stage Dockerfile with s-ui + sing-box</name>
  <files>Dockerfile</files>
  <action>
Create Dockerfile with multi-stage build per RESEARCH:

Stage 1 (frontend): FROM node:22-alpine AS frontend. WORKDIR /app/web. COPY web/package.json web/bun.lock* (or bun.lock). RUN bun install --frozen-lockfile. COPY web/ ./ . RUN bun run build. Output: /app/web/dist.

Stage 2 (backend): FROM golang:1.25-alpine AS backend. WORKDIR /app. COPY go.mod go.sum ./ . RUN go mod download. COPY . . . Copy dist from frontend: COPY --from=frontend /app/web/dist ./web/dist. RUN CGO_ENABLED=0 go build -ldflags="-s -w" -o /s-ui ./cmd/server. (CGO_ENABLED=0 succeeds because 08-01 migrates to pure-Go SQLite; no gcc/sqlite-dev needed.)

Stage 3 (runtime): FROM alpine:3.20. RUN apk add --no-cache ca-certificates. COPY --from=backend /s-ui /s-ui. Download sing-box: Fetch latest release from api.github.com/repos/SagerNet/sing-box/releases/latest, get tag, download sing-box-{tag}-linux-{arch}.tar.gz (detect arch: amd64 or arm64 via uname -m in build, or use build args GOARCH). Simpler: use build-arg TARGETARCH (Docker buildx). RUN wget or curl to download, extract to /usr/local/bin/sing-box or /data/bin/sing-box. Or: ARG TARGETARCH, RUN curl -fsSL .../sing-box-${VERSION}-linux-${TARGETARCH}.tar.gz | tar xz -C /tmp && mv /tmp/sing-box-*/sing-box /usr/local/bin/sing-box.

Use deterministic sing-box version: ARG SINGBOX_VERSION=1.10.0 (or fetch latest at build time). Recommendation: Use fixed version in Dockerfile for reproducibility; document how to override.

COPY docker-entrypoint.sh / . ENTRYPOINT ["/docker-entrypoint.sh"]. Working directory /data. Create /data. ENV CONFIG_PATH=/data/config.json DATA_DIR=/data. Default singbox path in panel config: /data/sing-box.json. Binary: SINGBOX_BINARY_PATH=/usr/local/bin/sing-box or /data/bin/sing-box.
</action>
  <verify>docker build -t s-ui . succeeds (requires 08-01 pure-Go SQLite migration); docker run --rm s-ui ls -la /s-ui /usr/local/bin/sing-box 2>/dev/null || docker run --rm s-ui which sing-box</verify>
  <done>Docker image builds; contains s-ui and sing-box binaries</done>
</task>

<task type="auto">
  <name>Task 2: docker-compose.yml with bind mount</name>
  <files>docker-compose.yml, docker-entrypoint.sh</files>
  <action>
Create docker-compose.yml:
- service s-ui: build: context: . dockerfile: Dockerfile. ports: "8080:8080". volumes: - ./data:/data (bind mount per CONTEXT). environment: CONFIG_PATH=/data/config.json, DATA_DIR=/data. Restart: unless-stopped.

Create docker-entrypoint.sh: Ensure /data exists. If /data/config.json not present, s-ui will auto-generate on first run (per 08-01). Exec s-ui. No need to start sing-box separately — s-ui ProcessManager starts sing-box when config is applied. So entrypoint: exec /s-ui. Or: just CMD ["/s-ui"]. If we need to set WorkingDirectory: WORKDIR /data, then exec /s-ui. Panel will write to /data. Check: s-ui needs CONFIG_PATH and DATA_DIR. Set in Dockerfile or compose: CONFIG_PATH=/data/config.json, DATA_DIR=/data. Panel auto-generates config on first run. Sing-box config path in panel config defaults to dataDir/sing-box.json = /data/sing-box.json. Good.

Add .dockerignore: web/node_modules, web/dist (we build in container), .git, .planning, *.md except README.
</action>
  <verify>cd project && docker compose up -d; sleep 5; curl -s http://localhost:8080/api/me or similar; docker compose down</verify>
  <done>docker compose up -d runs; panel accessible; data persists in ./data</done>
</task>

</tasks>

<verification>
- docker build succeeds
- docker compose up -d runs panel
- ./data bind mount persists config and database
- Panel and sing-box both available in container
</verification>

<success_criteria>
- Single container with s-ui + sing-box
- Bind mount for data and config
- One-command deploy: docker compose up -d
</success_criteria>

<output>
After completion, create `.planning/phases/08-deployment-production/08-02-SUMMARY.md`
</output>
