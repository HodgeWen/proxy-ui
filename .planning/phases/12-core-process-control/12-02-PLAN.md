---
phase: 12-core-process-control
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - web/src/lib/core-status.ts
  - web/src/pages/Core.tsx
autonomous: true
requirements: [CORE-01, CORE-02, CORE-03, CORE-04]

must_haves:
  truths:
    - "Core 页面按四态渲染不同状态文案和引导，不再只有 running/stopped 二态"
    - "running 状态显示 Stop + Restart；stopped 状态显示 Start"
    - "not_installed 状态显示安装提示与明确下载/安装引导"
    - "error 状态显示 Retry Start + View Logs，不显示误导性的 Restart"
    - "状态查询保持 TanStack Query 5s 轮询，动作后可刷新状态并反馈结果"
  artifacts:
    - path: "web/src/lib/core-status.ts"
      provides: "前端状态标签、动作矩阵、状态辅助映射"
      exports: ["CORE_STATES", "ACTIONS_BY_STATE", "getStateMeta"]
    - path: "web/src/pages/Core.tsx"
      provides: "按状态驱动的核心控制 UI（含日志查看与错误态动作）"
      contains: "refetchInterval: 5000"
  key_links:
    - from: "web/src/pages/Core.tsx"
      to: "/api/core/status"
      via: "useQuery 轮询状态"
      pattern: "queryKey: \\[\"core\", \"status\"\\]"
    - from: "web/src/pages/Core.tsx"
      to: "/api/core/start|/api/core/stop|/api/core/restart"
      via: "useMutation 执行生命周期动作"
      pattern: "/api/core/(start|stop|restart)"
    - from: "web/src/pages/Core.tsx"
      to: "/api/core/logs"
      via: "error 状态按需读取日志"
      pattern: "/api/core/logs"
    - from: "web/src/pages/Core.tsx"
      to: "web/src/lib/core-status.ts"
      via: "状态->动作映射驱动按钮渲染"
      pattern: "ACTIONS_BY_STATE"
---

<objective>
将 Core 页面改造为完全状态驱动 UI：四态展示 + 上下文动作矩阵 + 错误态恢复入口（重试与日志）。

Purpose: 让用户在任意核心生命周期状态都看到准确、可执行且不误导的操作，完成 Phase 12 的用户可见体验目标。
Output: `Core.tsx` 支持四态差异化展示、动作按钮矩阵、安装提示与日志查看。
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/12-core-process-control/12-RESEARCH.md
@.planning/phases/12-core-process-control/12-01-PLAN.md
@web/src/pages/Core.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: 更新前端状态契约并接入 start/stop/restart API</name>
  <files>web/src/lib/core-status.ts, web/src/pages/Core.tsx</files>
  <action>
在 `web/src/lib/core-status.ts` 定义并导出前端状态常量、动作矩阵和状态展示元数据，确保状态文案、颜色和按钮策略集中管理，避免散落 `if/else`。

在 `web/src/pages/Core.tsx` 更新 `CoreStatus` 类型以消费后端新字段（至少包含 `state/actions/lastError/running/version/binaryPath/configPath`），并将原先仅 `restart` mutation 扩展为独立的 `start/stop/restart` mutations。保持现有 TanStack Query 轮询机制不变：`refetchInterval: 5000`，禁止改成 SSE。

动作执行成功后统一 `invalidateQueries(["core", "status"])`，失败时按后端语义错误码显示更清晰提示（如 not installed / already running / start failed）。
  </action>
  <verify>
- `rg "refetchInterval:\\s*5000" web/src/pages/Core.tsx` 能匹配；
- `rg "/api/core/(start|stop|restart)" web/src/pages/Core.tsx` 能匹配三类动作接口；
- `npm run build`（在 `web/` 下）通过。
  </verify>
  <done>
- Core 页面已消费四态状态结构并具备独立 start/stop/restart 动作调用能力；
- 轮询间隔保持 5s 且动作后状态刷新链路完整。
  </done>
</task>

<task type="auto">
  <name>Task 2: 实现四态差异化 UI 与动作矩阵渲染</name>
  <files>web/src/pages/Core.tsx</files>
  <action>
重构状态卡片主区域，按 state 渲染不同 UI：
- `running`: 显示“运行中”视觉状态 + Stop/Restart；
- `stopped`: 显示“已停止” + Start；
- `not_installed`: 显示“未安装”状态、二进制路径信息、下载/安装引导 CTA（可为按钮或跳转链接，但必须明确可执行）；
- `error`: 显示“启动异常”状态、简要错误上下文、Retry Start + View Logs。

严格禁止在 `error` 状态展示“Restart”作为主恢复动作，避免违反 CORE-03。保留已有版本信息、更新/回滚能力，但将生命周期按钮区改为状态矩阵驱动渲染。
  </action>
  <verify>
- 手工检查四态映射：每个 state 都有唯一主文案和按钮集合；
- `error` 分支仅出现 `Retry Start`、`View Logs`（无 `Restart`）；
- `not_installed` 分支包含明确安装提示与 CTA。
  </verify>
  <done>
- 前端满足 Success Criteria #1 #2 #3 #4 的可见行为要求；
- 生命周期按钮语义与后端状态严格对齐。
  </done>
</task>

<task type="auto">
  <name>Task 3: 补齐错误态日志查看与交互反馈</name>
  <files>web/src/pages/Core.tsx</files>
  <action>
在 Core 页面新增“查看日志”交互流程：点击 `View Logs` 时请求 `GET /api/core/logs`，在 Dialog 中展示最近日志内容；若日志缺失或读取失败，提供可理解的回退提示（不是静默失败）。

同时统一动作反馈策略：
- start/stop/restart/retry 成功时 toast 成功并刷新状态；
- 失败时 toast 错误，必要时展示 detail；
- 日志读取中的 loading/empty/error 状态要可区分。

保留并兼容已有更新/回滚对话框，不引入新依赖。
  </action>
  <verify>
- `npm run build` 通过；
- 在 error 状态点击 `View Logs` 可看到日志内容或清晰的“暂无日志/读取失败”提示；
- start 失败后 UI 保持在 error 分支并继续显示 `Retry Start` 与 `View Logs`。
  </verify>
  <done>
- error 状态恢复路径完整：可重试、可诊断；
- Core 页面动作反馈在成功/失败/空日志场景下都可预期。
  </done>
</task>

</tasks>

<verification>
1. 在 `web/` 执行 `npm run build` 成功。
2. 手工状态验证（可通过后端 mock/真实状态）：
   - running -> 显示 Stop/Restart
   - stopped -> 显示 Start
   - not_installed -> 显示安装引导
   - error -> 显示 Retry Start/View Logs
3. 确认 `error` 状态下不再渲染 Restart 主动作。
4. 确认状态轮询仍为 5s 周期且动作后会刷新状态。
</verification>

<success_criteria>
- CORE-04：前端已按四态分别渲染 UI；
- CORE-01：状态对应动作按钮为 start/stop/restart 分离；
- CORE-02：未安装场景可见并可执行安装引导；
- CORE-03：失败后显示 Retry Start + View Logs，移除误导性 Restart。
</success_criteria>

<output>
After completion, create `.planning/phases/12-core-process-control/12-02-SUMMARY.md`
</output>
