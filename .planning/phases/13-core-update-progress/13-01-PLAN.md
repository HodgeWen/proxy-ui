---
phase: 13-core-update-progress
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/core/update_progress_state.go
  - internal/core/update_progress_state_test.go
  - internal/core/updater.go
  - internal/api/core.go
  - internal/api/routes.go
  - internal/api/core_test.go
autonomous: true
requirements: [UPDT-01, UPDT-02]
must_haves:
  truths:
    - "更新进行中时，重复调用更新接口会稳定返回 HTTP 409，且不会启动第二个下载任务。"
    - "订阅 SSE 的客户端能持续收到真实下载百分比，刷新后可先收到当前快照再继续增量更新。"
    - "SSE 连接断开或页面离开后，服务端订阅会及时清理，不残留悬挂连接。"
  artifacts:
    - path: internal/core/update_progress_state.go
      provides: "更新进度单一真相源（TryLock、快照、订阅广播、结束状态收敛）"
    - path: internal/core/updater.go
      provides: "基于下载字节与 Content-Length 的真实百分比回调"
    - path: internal/api/core.go
      provides: "POST /api/core/update 异步触发与 GET /api/core/update/stream SSE 推送"
    - path: internal/api/routes.go
      provides: "注册 /api/core/update/stream 路由"
    - path: internal/api/core_test.go
      provides: "409 并发保护与 SSE 协议头/快照行为测试"
  key_links:
    - from: internal/api/core.go
      to: internal/core/update_progress_state.go
      via: "POST 更新入口 TryLock + 异步任务状态广播"
      pattern: "TryLock|http.StatusConflict|Begin|Finish|Publish"
    - from: internal/core/updater.go
      to: internal/core/update_progress_state.go
      via: "下载过程百分比回调写入进度快照"
      pattern: "Content-Length|io.Copy|onProgress|percent"
    - from: internal/api/core.go
      to: SSE clients
      via: "stream handler 首包快照 + flush + r.Context().Done() 清理"
      pattern: "text/event-stream|X-Accel-Buffering|r.Context\\(\\)\\.Done\\(\\)"
---

<objective>
实现后端“触发更新 + SSE 进度流 + 并发防重入”的核心闭环，确保真实下载百分比可被订阅且重复触发可被强约束拒绝。

Purpose: 满足 Phase 13 的实时进度与重复触发保护目标，为前端极简进度展示提供稳定单一数据源。
Output: 可并发安全的更新协调器、SSE 流接口、下载百分比回调与后端测试覆盖。
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-core-update-progress/13-CONTEXT.md
@.planning/phases/13-core-update-progress/13-RESEARCH.md
@internal/api/core.go
@internal/api/routes.go
@internal/core/updater.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立更新进度协调器与 TryLock 并发保护</name>
  <files>internal/core/update_progress_state.go, internal/core/update_progress_state_test.go</files>
  <action>新增全局更新协调器，维护 inProgress/percent/updatedAt/error/version 等快照并支持订阅广播；入口并发控制必须使用 sync.Mutex + TryLock（禁止仅靠前端禁用）；定义 Begin/Publish/Finish/Subscribe/Unsubscribe API，确保非发起方也能拿到同一快照；补齐并发与快照测试，覆盖 TryLock 失败语义、广播一致性、结束后状态收敛。</action>
  <verify>go test ./internal/core -run 'UpdateProgress|TryLock' -count=1</verify>
  <done>协调器可在并发触发时稳定拒绝重复任务，且任意订阅方都能获得一致进度快照与结束状态。</done>
</task>

<task type="auto">
  <name>Task 2: 改造下载流程以输出真实百分比</name>
  <files>internal/core/updater.go</files>
  <action>在不新增任何 Go 依赖前提下扩展 CoreUpdater 的更新流程，基于下载字节流与 Content-Length 计算真实百分比并回调；当 Content-Length 缺失时采用可解释降级（保持最近有效值并仅在完成时置 100），避免伪进度阶段文案；保持现有更新行为（备份、替换、重启）不回退。</action>
  <verify>go test ./internal/core -run Update -count=1</verify>
  <done>下载过程中能持续产出单调递增百分比，完成后进度归一到 100 且原更新主流程不破坏。</done>
</task>

<task type="auto">
  <name>Task 3: 暴露更新触发与 SSE 流接口并补齐 API 测试</name>
  <files>internal/api/core.go, internal/api/routes.go, internal/api/core_test.go</files>
  <action>将 POST /api/core/update 改为快速返回的异步触发接口：TryLock 失败返回 409（明确冲突码），成功返回 accepted 状态；新增 GET /api/core/update/stream SSE，响应头必须包含 Content-Type: text/event-stream、Cache-Control: no-cache, no-transform、X-Accel-Buffering: no，并在连接建立后立即下发当前快照；循环推送时每次 flush，监听 r.Context().Done() 做退订清理；补充测试覆盖 409、防重复触发、SSE 头部与首包快照。</action>
  <verify>go test ./internal/api -run 'Update|Stream|Conflict' -count=1</verify>
  <done>后端具备可用的 POST 触发 + GET SSE 架构，重复触发稳定返回 409，且 SSE 无缓冲并具备断连清理。</done>
</task>

</tasks>

<verification>
1) `go test ./internal/core ./internal/api -count=1` 全量通过。  
2) 手工验证：并发发送两个 `POST /api/core/update`，仅一个成功启动，另一个返回 409。  
3) 手工验证：连接 `GET /api/core/update/stream` 能持续收到百分比事件，断开后服务端无持续写入错误日志。
</verification>

<success_criteria>
- 满足 UPDT-02：重复触发不会启动第二个下载任务，HTTP 409 语义稳定。  
- 满足 UPDT-01（后端部分）：SSE 连续推送真实下载百分比，并支持刷新后首包快照恢复。  
- 满足 Phase 成功标准 3：SSE 禁缓冲头完整，导航断连可清理无泄漏。
</success_criteria>

<output>
After completion, create `.planning/phases/13-core-update-progress/13-01-SUMMARY.md`
</output>
