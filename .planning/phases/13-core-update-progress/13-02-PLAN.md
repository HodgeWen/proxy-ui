---
phase: 13-core-update-progress
plan: 02
type: execute
wave: 2
depends_on: [13-01]
files_modified:
  - web/src/components/ui/progress.tsx
  - web/src/hooks/use-core-update-stream.ts
  - web/src/pages/Core.tsx
autonomous: true
requirements: [UPDT-01, UPDT-02]
must_haves:
  truths:
    - "用户在核心页能看到实时进度条与固定可见百分比，主文案保持“更新中 xx%”极简样式。"
    - "刷新页面后会尽快恢复当前进度；若更新已结束，页面回到普通状态且不弹额外成功提示。"
    - "非发起标签页在更新中倾向静默禁用更新按钮；即使后端兜底 409，也不会触发高噪音反馈。"
  artifacts:
    - path: web/src/hooks/use-core-update-stream.ts
      provides: "EventSource 订阅、首包/增量合并、cleanup close"
    - path: web/src/components/ui/progress.tsx
      provides: "核心页复用的 Progress 组件封装"
    - path: web/src/pages/Core.tsx
      provides: "极简更新进度 UI、按钮禁用策略、409 轻提示策略"
  key_links:
    - from: web/src/hooks/use-core-update-stream.ts
      to: /api/core/update/stream
      via: "EventSource 生命周期与消息解析"
      pattern: "new EventSource|onmessage|close\\(\\)"
    - from: web/src/pages/Core.tsx
      to: use-core-update-stream
      via: "更新中状态驱动文案、百分比与按钮禁用"
      pattern: "更新中 .*%|disabled|isUpdating"
    - from: web/src/pages/Core.tsx
      to: /api/core/update
      via: "触发更新 mutation 的 409 语义处理"
      pattern: "status === 409|Conflict|toast"
---

<objective>
实现前端极简实时进度体验：更新中持续显示百分比进度，刷新可恢复，多标签场景下保持低噪音且与后端 409 语义一致。

Purpose: 将 13-01 提供的后端能力转化为稳定、低信息密度、符合锁定决策的用户体验。
Output: Progress 组件、SSE hook、Core 页更新交互与文案策略落地。
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-core-update-progress/13-CONTEXT.md
@.planning/phases/13-core-update-progress/13-RESEARCH.md
@.planning/phases/13-core-update-progress/13-01-PLAN.md
@web/src/pages/Core.tsx
@web/src/lib/core-status.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: 实现前端 SSE 进度订阅 Hook 与清理机制</name>
  <files>web/src/hooks/use-core-update-stream.ts</files>
  <action>新增 use-core-update-stream hook，封装 EventSource("/api/core/update/stream") 的连接、消息解析、错误回退与 cleanup（组件卸载必须 close）；首包快照与后续增量统一归一为 percent/isUpdating/updatedAt/error 结构，供页面刷新后尽快恢复当前进度；保持与现有 TanStack Query 状态轮询并行（5s 不改为 SSE）。</action>
  <verify>pnpm -C web typecheck || npm --prefix web run typecheck || bun --cwd web run typecheck</verify>
  <done>Hook 在挂载时建立单连接、卸载时必定关闭，返回可直接驱动“更新中 xx%”UI 的稳定状态。</done>
</task>

<task type="auto">
  <name>Task 2: 在 Core 页面落地极简进度条与固定百分比</name>
  <files>web/src/components/ui/progress.tsx, web/src/pages/Core.tsx</files>
  <action>新增/接入 Progress 组件并在 Core 更新区渲染低密度 UI：仅显示“更新中 xx%”与进度条，百分比数字固定可见；禁止引入额外阶段提示（如准备中/下载中/完成）；更新结束后恢复普通状态且不弹额外成功提示；按钮在更新中默认静默禁用，兼容多标签页非发起场景。</action>
  <verify>pnpm -C web build || npm --prefix web run build || bun --cwd web run build</verify>
  <done>核心页在更新期间始终可见实时百分比与进度条，界面信息密度保持简洁且符合锁定文案策略。</done>
</task>

<task type="auto">
  <name>Task 3: 对齐 409 兜底语义与低噪音反馈策略</name>
  <files>web/src/pages/Core.tsx</files>
  <action>调整 update mutation 错误处理：当按钮已禁用仍收到 409 时按 discretion 采用“轻提示一次或静默”策略，避免重复高噪音 toast；仅对真实异常保留错误提示；确保多标签并发点击时，前端行为与后端 TryLock 409 完整对齐且不触发重复请求风暴。</action>
  <verify>手工验证：两个标签页同时点击更新，非发起页按钮保持禁用且不会持续弹错；网络面板仅存在预期请求</verify>
  <done>409 被视为并发保护语义的一部分而非普通失败，用户感知稳定、低噪音。</done>
</task>

</tasks>

<verification>
1) 打开核心页点击更新，观察文案为“更新中 xx%”，百分比始终可见且随 SSE 实时变化。  
2) 刷新页面后进度快速恢复到当前百分比；更新完成后页面回归普通状态，无额外成功提示。  
3) 双标签并发触发时，仅一个请求启动更新，另一路径遵循静默禁用/轻提示策略，且后端返回 409 语义可见。  
4) 切换路由离开核心页后，浏览器中 EventSource 连接被关闭，无持续连接泄漏。
</verification>

<success_criteria>
- 满足 UPDT-01（前端部分）：Progress 组件展示实时百分比进度，文案极简且百分比固定可见。  
- 满足 UPDT-02（前端协同部分）：按钮禁用策略与 409 兜底语义一致，重复触发不造成重复下载与高噪音提示。  
- 满足 Phase 成功标准 3（前端侧）：导航离开后 EventSource cleanup 正常，无连接泄漏。
</success_criteria>

<output>
After completion, create `.planning/phases/13-core-update-progress/13-02-SUMMARY.md`
</output>
