---
phase: 11-ui-animation-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web/src/hooks/use-count-up.ts
  - web/src/components/ui/spotlight-card.tsx
  - web/src/pages/Dashboard.tsx
  - web/src/pages/Traffic.tsx
autonomous: true
requirements: [UIANM-01, UIANM-03]

must_haves:
  truths:
    - "Dashboard stat numbers animate from 0 to actual values on page load"
    - "Traffic stat numbers animate from 0 to actual values"
    - "Numbers display comma separators throughout the entire animation"
    - "Dashboard cards glow with a spotlight that follows the cursor on hover"
    - "Spotlight is subtle in light mode, more visible in dark mode"
    - "Dashboard and Traffic cards fade+scale in with stagger on mount"
    - "Animations are skipped when prefers-reduced-motion is set"
  artifacts:
    - path: "web/src/hooks/use-count-up.ts"
      provides: "useCountUp hook with rAF animation loop"
      exports: ["useCountUp"]
    - path: "web/src/components/ui/spotlight-card.tsx"
      provides: "SpotlightCard with cursor-following radial gradient overlay"
      exports: ["SpotlightCard"]
    - path: "web/src/pages/Dashboard.tsx"
      provides: "Dashboard with CountUp numbers, SpotlightCard wrappers, entrance animations"
    - path: "web/src/pages/Traffic.tsx"
      provides: "Traffic with CountUp stat numbers and entrance animations"
  key_links:
    - from: "web/src/pages/Dashboard.tsx"
      to: "web/src/hooks/use-count-up.ts"
      via: "import { useCountUp }"
      pattern: "useCountUp\\("
    - from: "web/src/pages/Dashboard.tsx"
      to: "web/src/components/ui/spotlight-card.tsx"
      via: "import { SpotlightCard }"
      pattern: "<SpotlightCard"
    - from: "web/src/pages/Traffic.tsx"
      to: "web/src/hooks/use-count-up.ts"
      via: "import { useCountUp }"
      pattern: "useCountUp\\("
    - from: "web/src/hooks/use-count-up.ts"
      to: "requestAnimationFrame"
      via: "rAF loop drives animation"
      pattern: "requestAnimationFrame"
    - from: "web/src/components/ui/spotlight-card.tsx"
      to: "onMouseMove"
      via: "cursor position tracking for gradient"
      pattern: "onMouseMove"
---

<objective>
Create animation primitives (useCountUp hook + SpotlightCard component) and integrate them into Dashboard and Traffic pages with entrance animations.

Purpose: Dashboard and Traffic are the most data-dense pages — CountUp makes numbers feel dynamic, SpotlightCard adds interactive polish, entrance animations make page loads feel smooth.
Output: Two new utility files + two updated pages with full animation integration.
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-ui-animation-foundation/11-RESEARCH.md
@.planning/phases/11-ui-animation-foundation/11-CONTEXT.md
@web/src/pages/Dashboard.tsx
@web/src/pages/Traffic.tsx
@web/src/hooks/use-mobile.ts
@web/src/lib/format.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useCountUp hook and SpotlightCard component</name>
  <files>web/src/hooks/use-count-up.ts, web/src/components/ui/spotlight-card.tsx</files>
  <action>
**useCountUp hook** (`web/src/hooks/use-count-up.ts`):

Create a custom hook with this interface:
```typescript
interface UseCountUpOptions {
  to: number
  from?: number        // default 0
  duration?: number    // seconds, default 0.8 (per CONTEXT: 0.8-1s)
  startWhen?: boolean  // gate animation start, default true
  separator?: string   // thousands separator, default ','
  decimals?: number    // decimal places, default 0
}
// Returns: { value: number, formatted: string }
```

Implementation details:
- Use `requestAnimationFrame` loop. On each frame, compute elapsed fraction `t = elapsed / (duration * 1000)`, clamp to [0, 1].
- Apply ease-out cubic: `eased = 1 - Math.pow(1 - t, 3)` (per CONTEXT: ease-out, starts fast, decelerates).
- Current value = `from + (to - from) * eased`. Format with `Intl.NumberFormat` using `separator` and `decimals` on EVERY frame (per CONTEXT: "动画过程中保持格式化显示").
- When `startWhen` transitions to `true`, begin animation. Initialize `value` to `from` before animation starts (per pitfall: avoid flashing wrong value).
- Check `window.matchMedia('(prefers-reduced-motion: reduce)').matches` — if true, skip animation entirely, return final formatted value immediately.
- Cleanup: cancel rAF on unmount or when `to` changes.
- When `to` changes after initial animation, re-animate from current value to new `to`.

**SpotlightCard component** (`web/src/components/ui/spotlight-card.tsx`):

Create a wrapper component (zero external deps, pure React + CSS):
```typescript
interface SpotlightCardProps {
  children: React.ReactNode
  className?: string
  spotlightColor?: string  // override gradient color
}
```

Implementation details:
- Track mouse position relative to the card container via `onMouseMove` on a wrapper div.
- Store `{ x, y }` in a ref (not state — avoid re-renders on every mouse move). Use a second ref for the overlay element and update its `background` style directly via `ref.current.style.background`.
- Render structure: outer div (relative, overflow-hidden, rounded-xl) → gradient overlay div (absolute inset-0, pointer-events-none, opacity-0, transition-opacity) → children.
- On mouse enter: set overlay opacity to 1. On mouse leave: set overlay opacity to 0.
- Gradient: `radial-gradient(circle 250px at ${x}px ${y}px, ${color}, transparent)`.
- Default `spotlightColor`: use CSS custom property approach — `'rgba(139, 92, 246, 0.08)'` for light mode, `'rgba(139, 92, 246, 0.15)'` for dark mode (per CONTEXT: subtle, brighter in dark). Detect dark mode via `document.documentElement.classList.contains('dark')` on mouse enter.
- Overlay transition: `transition: opacity 300ms ease`.
- If `prefers-reduced-motion`, still render the component but without the gradient animation (show static subtle border glow instead, or just skip the effect).
- The component should NOT interfere with children layout — it's purely visual overlay.
  </action>
  <verify>
- `npx tsc --noEmit` passes with no errors in the two new files.
- `use-count-up.ts` exports `useCountUp` function.
- `spotlight-card.tsx` exports `SpotlightCard` component.
- `useCountUp({ to: 1000, separator: ',' })` would return `{ value: number, formatted: string }` shape.
  </verify>
  <done>
- `useCountUp` hook exists with rAF animation, ease-out cubic, formatted output, reduced-motion support.
- `SpotlightCard` component exists with mouse-tracking gradient overlay, dark mode awareness, no external deps.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate animations into Dashboard and Traffic pages</name>
  <files>web/src/pages/Dashboard.tsx, web/src/pages/Traffic.tsx</files>
  <action>
**Dashboard.tsx:**

1. Import `useCountUp` from `@/hooks/use-count-up` and `SpotlightCard` from `@/components/ui/spotlight-card`.

2. Replace static number displays with CountUp:
   - `stats?.inbound_count ?? 0` → use `useCountUp({ to: stats?.inbound_count ?? 0, startWhen: !isLoading, duration: 0.8 })`, display `formatted`.
   - `stats?.user_count ?? 0` → same pattern.
   - `stats?.active_user_count ?? 0` → same pattern (this is the sub-text "活跃 N").
   - `stats?.total_uplink` and `stats?.total_downlink` — these use `formatBytes()` which produces strings like "1.5 GB". For traffic values, use `useCountUp` on the raw byte number and pass the `value` through `formatBytes()` on each render. This way the byte count animates and formatting updates in real-time.
   - All CountUp instances use `startWhen: !isLoading` so they all start simultaneously when data arrives (per CONTEXT: "所有统计数字同时开始滚动").
   - While loading (`isLoading`), show "..." as before. Once loaded, CountUp takes over from 0 → actual value.

3. Wrap each of the 3 stat Cards in `<SpotlightCard>`:
   ```tsx
   <SpotlightCard>
     <Card className="transition-shadow hover:shadow-md">
       ...
     </Card>
   </SpotlightCard>
   ```
   Per CONTEXT: "Dashboard 所有主要卡片" — all 3 stat cards get SpotlightCard.

4. Add entrance animations to the card grid. Wrap each card container (SpotlightCard) in a div with tw-animate-css classes:
   ```tsx
   <div
     className="animate-in fade-in zoom-in-95 duration-300 fill-mode-both motion-reduce:animate-none"
     style={{ animationDelay: `${index * 75}ms` }}
   >
     <SpotlightCard>
       <Card>...</Card>
     </SpotlightCard>
   </div>
   ```
   Use 75ms stagger (within CONTEXT 50-100ms range). 3 cards → delays: 0ms, 75ms, 150ms.

5. Remove the loading "..." for CountUp fields — instead, when `isLoading` is true, show "0" (since CountUp starts from 0 anyway, and the entrance animation will be playing).

**Traffic.tsx:**

1. Import `useCountUp` from `@/hooks/use-count-up`.

2. Apply CountUp to the 3 stat cards' numbers:
   - `totalUplink` / `totalDownlink` → `useCountUp({ to: totalUplink, startWhen: !inboundsLoading })`, then `formatBytes(uplinkCountUp.value)`.
   - `activeUsers` → `useCountUp({ to: activeUsers, startWhen: !usersLoading })`.
   - `inbounds.length` → `useCountUp({ to: inbounds.length, startWhen: !inboundsLoading })`.
   - Sub-text values (e.g., "共 N 个用户") also get CountUp for consistency.

3. Add entrance animations to the stat card grid. Same pattern as Dashboard:
   ```tsx
   <div
     className="animate-in fade-in zoom-in-95 duration-300 fill-mode-both motion-reduce:animate-none"
     style={{ animationDelay: `${index * 75}ms` }}
   >
     <Card>...</Card>
   </div>
   ```
   3 stat cards → delays: 0ms, 75ms, 150ms.

4. Add entrance animation to the Tabs section below the stats:
   ```tsx
   <div className="animate-in fade-in zoom-in-95 duration-300 fill-mode-both motion-reduce:animate-none" style={{ animationDelay: '225ms' }}>
     <Tabs>...</Tabs>
   </div>
   ```

Do NOT import from `react-bits` npm package (it's a different library — see RESEARCH critical discovery).
  </action>
  <verify>
- `npm run build` completes with no errors.
- Open Dashboard in browser: stat numbers animate from 0 to actual values over ~0.8s with comma formatting.
- Hover over any Dashboard card: see spotlight glow following cursor.
- Dashboard cards stagger in with fade+scale on page load.
- Traffic stat numbers animate from 0 on page load.
- Traffic cards stagger in on load.
- Set `prefers-reduced-motion: reduce` in browser DevTools → animations skip, values show immediately.
  </verify>
  <done>
- Dashboard shows animated CountUp numbers, SpotlightCard hover glow on all 3 stat cards, and staggered entrance animation.
- Traffic shows animated CountUp numbers on all 3 stat cards and staggered entrance animation.
- All animations respect reduced-motion preference.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with zero errors.
2. Dashboard: numbers roll up from 0 → actual, spotlight glow follows cursor, cards fade+scale in.
3. Traffic: numbers roll up from 0 → actual, cards fade+scale in.
4. Reduced motion: all animations skip gracefully.
5. Data refetch (30s/60s intervals): CountUp re-animates to new value smoothly, entrance does NOT replay.
</verification>

<success_criteria>
- useCountUp hook produces formatted animated numbers with rAF + ease-out cubic
- SpotlightCard renders cursor-tracking gradient overlay, theme-aware opacity
- Dashboard and Traffic pages integrate both animation types with zero layout shift
- No new npm dependencies added
</success_criteria>

<output>
After completion, create `.planning/phases/11-ui-animation-foundation/11-01-SUMMARY.md`
</output>
