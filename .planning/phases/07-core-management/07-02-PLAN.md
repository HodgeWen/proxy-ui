---
phase: 07-core-management
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - web/src/pages/Dashboard.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard shows current sing-box version and latest available version"
    - "Admin can click update and confirm to update to latest"
    - "Admin can click rollback to restore previous version"
    - "New version available badge visible when update is available"
  artifacts:
    - path: "web/src/pages/Dashboard.tsx"
      provides: "Core version card with update/rollback, version list, confirm dialog, new version badge"
      contains: "更新"
  key_links:
    - from: "web/src/pages/Dashboard.tsx"
      to: "/api/core/versions"
      via: "useQuery fetch"
      pattern: "api/core/versions"
    - from: "web/src/pages/Dashboard.tsx"
      to: "/api/core/update"
      via: "useMutation POST"
      pattern: "api/core/update"
---

<objective>
Dashboard CoreVersionCard: current + latest, update with confirm dialog, rollback, version list with stable/pre-release badges, new-version badge.

Purpose: Per CONTEXT: 嵌入仪表盘、展示当前+最新、更新按钮确认、Sidebar 或 Dashboard 显示新版本徽标。Frontend consumes 07-01 APIs.

Output: Extended Dashboard with version block; update/rollback actions; confirm dialog; version list (all releases, stable/pre-release markers); badge when update available.
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-core-management/07-RESEARCH.md
@.planning/phases/07-core-management/07-CONTEXT.md
@web/src/pages/Dashboard.tsx
@web/src/components/layout/Sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Core version card + update/rollback</name>
  <files>web/src/pages/Dashboard.tsx</files>
  <action>
Extend Dashboard with sing-box core version management (add a new Card or extend existing sing-box status area):

- Fetch GET /api/core/versions (queryKey ["core","versions"]). Parse releases: {tag, version, prerelease}.
- Latest stable = first release with prerelease=false. Latest overall = first release.
- Display: 当前版本: {status.version from existing status query}, 最新版本: {latestStable?.version or latestOverall?.version}.
- Update button: on click open confirm Dialog "确定要将 sing-box 更新到最新版本吗？更新过程中服务将短暂停止。" Cancel / 确定. On 确定: POST /api/core/update. On success: invalidate ["core","status"], ["core","versions"], toast.success("更新成功"). On error: toast.error(err.message). Disable button when updateMutation.isPending. Show step progress or spinner during update (Claude's discretion: use Loader2 spinner).
- Rollback button: on click open confirm Dialog "确定要回滚到上一版本吗？". Cancel / 确定. On 确定: POST /api/core/rollback. Same success/error handling. Disable when rollbackMutation.isPending.
- When SINGBOX_BINARY_PATH not set and update fails with "请设置", show helpful message in UI (e.g. "核心更新需要设置 SINGBOX_BINARY_PATH").
- Keep existing sing-box status card (running, version, restart). Either merge version management into that card or add adjacent card. Prefer: one card "sing-box 状态与版本" combining status + current/latest + update/rollback.
</action>
  <verify>npm run build; grep -l "api/core/versions" web/src/pages/Dashboard.tsx; grep -l "api/core/update" web/src/pages/Dashboard.tsx</verify>
  <done>Dashboard shows current+latest; update and rollback with confirm dialogs work</done>
</task>

<task type="auto">
  <name>Task 2: Version list + new version badge</name>
  <files>web/src/pages/Dashboard.tsx</files>
  <action>
Version list (per CONTEXT: 展示所有版本，标记 stable/pre-release):

- Add "查看所有版本" link or button. Opens Dialog/Modal with list of releases (from versions API). Each row: tag, Badge "stable" (green) or "pre-release" (amber) per prerelease field. Use shadcn Badge. Scrollable list.
- New version badge: when status.version exists and latestStable exists and status.version !== latestStable.version, show badge. Place on the sing-box card header (e.g. small badge "有新版本") or on Sidebar Dashboard nav item. Per CONTEXT: "Sidebar 或 Dashboard 显示新版本可用徽标". Use Dashboard card badge: when update available, show Badge variant="secondary" or similar next to card title "有新版本".
- Per CONTEXT "Sidebar 或 Dashboard": use Dashboard card badge only (simpler).
</action>
  <verify>npm run build; grep -l "有新版本" web/src/pages/Dashboard.tsx; grep -l "prerelease" web/src/pages/Dashboard.tsx</verify>
  <done>Version list modal with stable/pre-release badges; new version badge when update available</done>
</task>

</tasks>

<verification>
- npm run build
- Dashboard: current + latest visible; update confirm works; rollback confirm works
- Version list shows all releases with stable/pre-release labels
- Badge appears when newer version available
</verification>

<success_criteria>
- Admin can update and rollback sing-box from Dashboard
- All versions visible with clear stable/pre-release markers
- New version badge guides admin to update
</success_criteria>

<output>
After completion, create `.planning/phases/07-core-management/07-02-SUMMARY.md`
</output>
