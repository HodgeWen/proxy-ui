---
phase: 06-traffic-statistics
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - internal/api/inbounds.go
  - internal/api/users.go
  - internal/core/subscription.go
  - internal/db/inbound.go
autonomous: true

must_haves:
  truths:
    - "ListInbounds returns traffic_uplink, traffic_downlink per inbound"
    - "ListInbounds supports ?sort=traffic_asc|traffic_desc"
    - "ListUsers/GetUser returns traffic_uplink, traffic_downlink"
    - "reset_traffic clears TrafficUplink, TrafficDownlink, TrafficUsed"
  artifacts:
    - path: "internal/api/inbounds.go"
      provides: "Traffic in list response, sort param"
      contains: "traffic_uplink"
    - path: "internal/api/users.go"
      provides: "traffic_uplink, traffic_downlink in user response"
      contains: "traffic_uplink"
  key_links:
    - from: "internal/api/inbounds.go"
      to: "internal/db"
      via: "ListInbounds with sort"
      pattern: "traffic_asc|traffic_desc"
    - from: "internal/api/users.go"
      to: "reset_traffic"
      via: "TrafficUplink=0, TrafficDownlink=0"
      pattern: "reset_traffic"
---

<objective>
Extend API responses to include traffic data and support inbound sort-by-traffic. Update reset_traffic to clear TrafficUplink/TrafficDownlink.

Purpose: Frontend needs traffic in list/get responses. Per CONTEXT: 入站列表支持按流量升降序排序.

Output: ListInbounds with traffic columns + sort param; ListUsers/GetUser with traffic_uplink, traffic_downlink; reset_traffic clears all traffic fields.
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-traffic-statistics/06-RESEARCH.md
@.planning/phases/06-traffic-statistics/06-CONTEXT.md
@internal/api/inbounds.go
@internal/api/users.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Inbound API traffic + sort</name>
  <files>internal/api/inbounds.go, internal/db/inbound.go</files>
  <action>
Add to inboundItem: TrafficUplink int64, TrafficDownlink int64 (json:"traffic_uplink", "traffic_downlink").
- inboundFromDB: set TrafficUplink, TrafficDownlink from ib.
- ListInboundsHandler: parse ?sort= query param. Values: "traffic_asc", "traffic_desc", or empty (default created_at desc).
- db.ListInbounds: add optional sort param. When sort="traffic_asc", Order("(traffic_uplink + traffic_downlink) ASC"). When "traffic_desc", Order("(traffic_uplink + traffic_downlink) DESC"). Default: Order("created_at DESC"). Signature: ListInbounds(sort string) ([]Inbound, error).
- Pass sort from handler to ListInbounds.
</action>
  <verify>go build ./...; curl -s http://localhost:8080/api/inbounds | jq '.data[0] | keys' | grep traffic</verify>
  <done>ListInbounds returns traffic; ?sort=traffic_asc|traffic_desc works</done>
</task>

<task type="auto">
  <name>Task 2: User API traffic + reset_traffic</name>
  <files>internal/api/users.go</files>
  <action>
Add to userItem: TrafficUplink int64, TrafficDownlink int64 (json:"traffic_uplink", "traffic_downlink").
- userFromDB: set TrafficUplink, TrafficDownlink from u. TrafficUsed stays as-is (UL+DL from DB).
- BatchUsersHandler reset_traffic: set updated.TrafficUplink = 0, updated.TrafficDownlink = 0, updated.TrafficUsed = 0 (all three).
- Subscription uses User.TrafficUplink, TrafficDownlink for real upload/download (Phase 5 used placeholder TrafficUsed/2). Update internal/core/subscription.go: upload = u.TrafficUplink, download = u.TrafficDownlink (replace TrafficUsed/2).
</action>
  <verify>go build ./...; curl -s http://localhost:8080/api/users | jq '.data[0] | keys' | grep traffic</verify>
  <done>User API returns traffic_uplink, traffic_downlink; reset_traffic clears all; subscription uses real UL/DL</done>
</task>

</tasks>

<verification>
- go build ./...
- GET /api/inbounds returns traffic_uplink, traffic_downlink
- GET /api/inbounds?sort=traffic_desc returns inbounds sorted by total traffic desc
- GET /api/users returns traffic_uplink, traffic_downlink
- POST /api/users/batch with action=reset_traffic clears TrafficUplink, TrafficDownlink, TrafficUsed
</verification>

<success_criteria>
- Traffic in list responses; sort works for inbounds
- reset_traffic clears all traffic fields; subscription uses real UL/DL
</success_criteria>

<output>
After completion, create `.planning/phases/06-traffic-statistics/06-02-SUMMARY.md`
</output>
