---
phase: 06-traffic-statistics
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - web/src/lib/format.ts
  - web/src/components/inbounds/InboundTable.tsx
  - web/src/components/users/UserTable.tsx
  - web/src/components/users/UserSubscriptionCard.tsx
  - web/src/pages/Inbounds.tsx
autonomous: true

must_haves:
  truths:
    - "Inbound table shows uplink and downlink traffic columns"
    - "Inbound list supports sort by traffic (asc/desc)"
    - "User table shows uplink and downlink traffic columns"
    - "User traffic over-limit status is visible"
  artifacts:
    - path: "web/src/lib/format.ts"
      provides: "formatBytes shared util"
      contains: "formatBytes"
    - path: "web/src/components/inbounds/InboundTable.tsx"
      provides: "Traffic columns, sortable"
      contains: "traffic_uplink"
    - path: "web/src/components/users/UserTable.tsx"
      provides: "Traffic columns"
      contains: "traffic_uplink"
  key_links:
    - from: "web/src/pages/Inbounds.tsx"
      to: "/api/inbounds"
      via: "fetch with ?sort= param"
      pattern: "sort="
    - from: "web/src/components/inbounds/InboundTable.tsx"
      to: "formatBytes"
      via: "import from @/lib/format"
      pattern: "formatBytes"
---

<objective>
Add traffic columns to Inbound and User tables. Extract formatBytes to shared lib. Support inbound sort-by-traffic. Traffic over-limit status per CONTEXT (Claude's discretion: use existing Badge pattern).

Purpose: Per CONTEXT: 流量数据直接内嵌在现有 Inbounds 列表表格中；用户列表表格中增加流量列（上行/下行），与入站保持一致的展示风格；流量超限与状态提示由 Claude 决定合理方案. Existing getStatusBadge already shows 超限 when traffic_used >= traffic_limit.

Output: InboundTable with 上行/下行 columns + sort control; UserTable with 上行/下行 columns; formatBytes in lib; status badge for over-limit (already exists).
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-traffic-statistics/06-CONTEXT.md
@web/src/components/inbounds/InboundTable.tsx
@web/src/components/users/UserTable.tsx
@web/src/pages/Inbounds.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: formatBytes util + InboundTable traffic</name>
  <files>web/src/lib/format.ts, web/src/components/inbounds/InboundTable.tsx, web/src/pages/Inbounds.tsx</files>
  <action>
Extract formatBytes to web/src/lib/format.ts:
- export function formatBytes(bytes: number): string — same logic as UserTable (0 B, KB, MB, GB, TB)

InboundTable:
- Extend Inbound type: traffic_uplink: number, traffic_downlink: number
- Add TableHead 上行, 下行 (after 用户数 or before 创建时间)
- Add TableCell with formatBytes(ib.traffic_uplink), formatBytes(ib.traffic_downlink)
- Import formatBytes from @/lib/format

Inbounds page:
- Add sort state: useState&lt;"created"|"traffic_asc"|"traffic_desc"&gt;("created")
- fetchInbounds: accept sort param; build URL /api/inbounds?sort=traffic_asc when sort !== "created"
- queryKey: ["inbounds", sort] so changing sort refetches
- Add Select or dropdown for sort: 默认 / 流量升序 / 流量降序. Place near title or above table.
- refetchInterval: 60000 (60s) for traffic freshness (Claude's discretion)
</action>
  <verify>npm run build; grep -l formatBytes web/src/lib/format.ts; grep traffic_uplink web/src/components/inbounds/InboundTable.tsx</verify>
  <done>InboundTable shows traffic columns; sort control works; formatBytes in lib</done>
</task>

<task type="auto">
  <name>Task 2: UserTable traffic columns</name>
  <files>web/src/components/users/UserTable.tsx, web/src/components/users/UserSubscriptionCard.tsx</files>
  <action>
Extend User type: traffic_uplink: number, traffic_downlink: number (alongside traffic_used)
- Replace single 流量 column with 上行 and 下行 columns (per CONTEXT: 与入站保持一致的展示风格)
- formatTraffic(used, limit) stays for limit display? No — CONTEXT says 流量列（上行/下行）. So we show uplink and downlink as two columns. For limit: traffic_used = traffic_uplink + traffic_downlink. Keep formatTraffic for "X / Y (N%)" where X = traffic_used, Y = limit. Or: CONTEXT says 流量列（上行/下行）— so two columns. We can have: 上行 | 下行 | 流量上限. The 流量 column currently shows "X / Y GB (N%)" or "无限制". Per CONTEXT we add 上行/下行. So we replace the single 流量 column with 上行 | 下行 columns. The limit/percentage can be in status badge (超限) or we keep a small 流量 column showing "X/Y" for limit. CONTEXT: 流量超限与状态提示由 Claude 决定合理方案. Existing getStatusBadge shows 超限. So we have: 上行 | 下行 as two columns. Status badge already shows 超限. We can add a third column "已用/上限" for limit display when limit &gt; 0, or keep it in status. Simpler: 上行 | 下行. Limit is in status (超限) and in the existing format. Actually the current table has 流量 which shows formatTraffic(used, limit). We're adding 上行/下行. So we could: Option A) Replace 流量 with 上行 | 下行 (lose limit display in that column). Option B) Add 上行 | 下行, keep 流量 for limit. CONTEXT: 与入站保持一致的展示风格. Inbound has 上行+下行 only, no limit. So User: 上行 | 下行. The limit/超限 is in status badge. So we replace 流量 column with 上行 | 下行. formatTraffic was "X / Y (N%)". We remove it; status badge shows 超限 when over limit. Good.
- UserTable: import formatBytes from @/lib/format; TableHead 上行, 下行; TableCell formatBytes(user.traffic_uplink), formatBytes(user.traffic_downlink)
- Delete local formatBytes and formatTraffic from UserTable. Use formatBytes from lib. For "over limit" indicator: keep getStatusBadge (uses traffic_used &gt;= traffic_limit). traffic_used comes from API. When limit &gt; 0, we could show "X/Y" in a subtle way — or just rely on badge. Per CONTEXT: 流量超限与状态提示由 Claude 决定合理方案. Badge 超限 is sufficient. Optionally add title/tooltip on traffic cell when near limit (e.g. &gt; 80%): "已用 80%". Keep it simple: badge + two columns.
- UserSubscriptionCard: import formatBytes from @/lib/format; remove local formatBytes. Subscription card shows traffic_used/traffic_limit — stays as is (uses traffic_used from API).
- refetchInterval: 60000 for users query (traffic freshness)
</action>
  <verify>npm run build; grep -l "@/lib/format" web/src/components/users/UserTable.tsx web/src/components/users/UserSubscriptionCard.tsx</verify>
  <done>UserTable shows 上行/下行 columns; formatBytes from lib; status badge for over-limit</done>
</task>

</tasks>

<verification>
- npm run build
- Inbounds page: traffic columns visible; sort dropdown works
- Users page: traffic columns visible; 超限 badge when over limit
</verification>

<success_criteria>
- Inbound and User tables show uplink/downlink traffic
- Inbound sort by traffic works
- Traffic refreshes every 60s
- Over-limit status visible via badge
</success_criteria>

<output>
After completion, create `.planning/phases/06-traffic-statistics/06-03-SUMMARY.md`
</output>
