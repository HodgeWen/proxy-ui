---
phase: 06-traffic-statistics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/db/inbound.go
  - internal/db/user.go
  - internal/db/db.go
  - internal/statsproto/command.proto
  - internal/statsproto/command_grpc.pb.go
  - internal/statsproto/command.pb.go
  - internal/core/stats.go
  - internal/core/generator.go
  - cmd/server/main.go
  - go.mod
  - go.sum
autonomous: true

must_haves:
  truths:
    - "Panel can connect to V2Ray API and fetch stats"
    - "Panel persists traffic deltas to DB (Inbound and User)"
    - "ConfigGenerator injects v2ray_api when stats enabled"
    - "Stats poll runs periodically (cron)"
  artifacts:
    - path: "internal/statsproto/command.proto"
      provides: "Minimal StatsService proto"
      contains: "QueryStatsRequest"
    - path: "internal/core/stats.go"
      provides: "StatsClient with delta aggregation"
      min_lines: 80
    - path: "internal/db/inbound.go"
      provides: "TrafficUplink, TrafficDownlink columns"
      contains: "TrafficUplink"
    - path: "internal/db/user.go"
      provides: "TrafficUplink, TrafficDownlink columns"
      contains: "TrafficUplink"
    - path: "internal/core/generator.go"
      provides: "experimental.v2ray_api injection"
      contains: "v2ray_api"
  key_links:
    - from: "internal/core/stats.go"
      to: "internal/db"
      via: "UpdateInbound, UpdateUser traffic delta"
      pattern: "db\.(UpdateInbound|UpdateUser)"
    - from: "internal/core/stats.go"
      to: "internal/statsproto"
      via: "gRPC QueryStats"
      pattern: "QueryStats"
    - from: "internal/core/generator.go"
      to: "internal/db"
      via: "ListInbounds, GetUsersForInbound for stats config"
      pattern: "v2ray_api"
---

<objective>
Establish traffic stats backend: V2Ray API gRPC client, DB columns, ConfigGenerator v2ray_api injection, and periodic stats polling.

Purpose: Phase 6 requires per-user and per-inbound traffic display. Traffic comes from sing-box's optional V2Ray API (gRPC). Without this foundation, the panel cannot collect or persist traffic data.

Output: StatsClient that polls API, computes deltas, persists to Inbound/User; ConfigGenerator injects v2ray_api block; cron runs every 60s (configurable).
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-traffic-statistics/06-RESEARCH.md
@.planning/phases/06-traffic-statistics/06-CONTEXT.md
@internal/core/generator.go
@internal/db/inbound.go
@internal/db/user.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: DB columns + ConfigGenerator v2ray_api</name>
  <files>internal/db/inbound.go, internal/db/user.go, internal/db/db.go, internal/core/generator.go</files>
  <action>
Add DB columns:
- Inbound: TrafficUplink int64, TrafficDownlink int64 (default 0)
- User: TrafficUplink int64, TrafficDownlink int64 (default 0). Keep TrafficUsed; StatsClient will set TrafficUsed = TrafficUplink + TrafficDownlink when updating. Reset clears all three. GetUsersForInbound limit check uses TrafficUsed.
- AutoMigrate includes new columns (already in Init).

ConfigGenerator v2ray_api injection (per RESEARCH Pattern 2):

- Add experimental.v2ray_api block to sing-box config when stats enabled. Use env V2RAY_API_ENABLED=true (default false) or similar to gate. Port from env V2RAY_API_LISTEN (default "127.0.0.1:8080").
- stats.enabled: true
- stats.inbounds: collect all Inbound.Tag from db.ListInbounds()
- stats.users: collect all User.Name from users assigned to each inbound (db.GetUsersForInbound per inbound, dedupe)
- stats.outbounds: ["direct"]
- Inject into cfg map before json.Marshal: cfg["experimental"] = map with v2ray_api.
- When V2RAY_API_ENABLED is false or unset, omit experimental block (no API, no stats).
  </action>
  <verify>go build ./...; grep -l TrafficUplink internal/db/inbound.go internal/db/user.go; grep -l v2ray_api internal/core/generator.go</verify>
  <done>Inbound and User have TrafficUplink/TrafficDownlink; ConfigGenerator injects v2ray_api when enabled</done>
  </task>

<task type="auto">
  <name>Task 2: Minimal proto + StatsClient</name>
  <files>internal/statsproto/command.proto, internal/statsproto/command.pb.go, internal/statsproto/command_grpc.pb.go, internal/core/stats.go</files>
  <action>
Create minimal proto (avoid v2ray-core heavy import; copy only QueryStats types):
- internal/statsproto/command.proto: package v2ray.core.app.stats.command; go_package "github.com/s-ui/s-ui/internal/statsproto"; message QueryStatsRequest { bool reset = 2; }; message Stat { string name = 1; int64 value = 2; }; message QueryStatsResponse { repeated Stat stat = 1; }; service StatsService { rpc QueryStats(QueryStatsRequest) returns (QueryStatsResponse); }
- Generate: protoc --go_out=. --go-grpc_out=. command.proto (requires protoc, protoc-gen-go, protoc-gen-go-grpc). Use go_package that matches module path.
- Run: buf generate or protoc; ensure generated files in internal/statsproto/

StatsClient (internal/core/stats.go):

- NewStatsClient(addr string) \*StatsClient
- FetchAndPersist(ctx) error: connect gRPC; call QueryStats with Reset: false (NEVER reset per RESEARCH). For each stat: parse name (inbound>>>{tag}>>>traffic>>>uplink|downlink, user>>>{name}>>>traffic>>>uplink|downlink). delta = value - lastSeen[name]; if delta &lt; 0 treat as restart (delta = value). lastSeen[name] = value. Map to Inbound (GetInboundByTag) or User (by Name; need db.GetUserByName or iterate ListUsers). Add delta to DB: UpdateInbound/UpdateUser with TrafficUplink += delta, TrafficDownlink += delta. For User also set TrafficUsed = TrafficUplink + TrafficDownlink.
- Graceful: if gRPC connect fails, log and return (don't crash). API unavailable â†’ stats stay 0.
- Add db.GetUserByName(name string) or use ListUsers and find by name.
- lastSeen map in-memory; accept small loss on panel restart (per RESEARCH).
  </action>
  <verify>go build ./...; grep -l StatsClient internal/core/stats.go</verify>
  <done>Proto generated; StatsClient fetches and persists traffic deltas</done>
  </task>

<task type="auto">
  <name>Task 3: Cron + main wiring</name>
  <files>cmd/server/main.go, go.mod</files>
  <action>
Add robfig/cron/v3: go get github.com/robfig/cron/v3

In main.go after db init:

- If V2RAY_API_ENABLED=true (or env check): create StatsClient(addr from V2RAY_API_LISTEN), start cron job every 60s (or V2RAY_STATS_INTERVAL seconds, default 60). Cron: c.AddFunc("@every 60s", func() { statsClient.FetchAndPersist(context.Background()) })
- c.Start(); defer c.Stop() or run in background. Use context.Background() for FetchAndPersist.
- When stats disabled, skip cron (no-op).
- Log when stats cron starts; log connect errors in FetchAndPersist (don't spam).
  </action>
  <verify>go build ./...; grep -l cron cmd/server/main.go</verify>
  <done>Cron runs FetchAndPersist every 60s when stats enabled</done>
  </task>

</tasks>

<verification>
- go build ./...
- DB migrations apply (TrafficUplink, TrafficDownlink on inbounds, users)
- With V2RAY_API_ENABLED=true and sing-box with v2ray_api, stats should populate (manual test)
- With stats disabled, panel runs normally; traffic columns stay 0
</verification>

<success_criteria>

- StatsClient polls V2Ray API; deltas persisted to Inbound and User
- ConfigGenerator injects v2ray_api when enabled
- When API unavailable, no crash; stats display 0
  </success_criteria>

<output>
After completion, create `.planning/phases/06-traffic-statistics/06-01-SUMMARY.md`
</output>
