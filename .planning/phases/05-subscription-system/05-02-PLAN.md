---
phase: 05-subscription-system
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - internal/api/users.go
  - internal/api/routes.go
autonomous: true

must_haves:
  truths:
    - "Admin can reset user subscription token (old link immediately invalid)"
    - "GetUser response includes subscription_url and subscription_nodes for admin display"
  artifacts:
    - path: internal/api/users.go
      provides: reset-subscription endpoint, subscription_url and subscription_nodes in GetUser
      contains: "subscription_url"
  key_links:
    - from: internal/api/users.go
      to: internal/core/subscription.go
      via: "GetNodeLinks for subscription_nodes"
      pattern: "GetNodeLinks"
    - from: internal/api/users.go
      to: internal/db/user.go
      via: "GetUserBySubscriptionToken, UpdateUser for reset"
      pattern: "subscription_token"
---

<objective>
Admin API: reset subscription token endpoint; extend GetUser response with subscription_url and subscription_nodes for admin panel display.

Purpose: Enable admin to reset token (old link invalid per CONTEXT); provide subscription info for UserSubscriptionCard in Plan 03.
Output: POST /api/users/:id/reset-subscription; GetUser returns subscription_url, subscription_nodes.
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-subscription-system/05-CONTEXT.md
@.planning/phases/05-subscription-system/05-RESEARCH.md
@internal/api/users.go
@internal/core/subscription.go
@internal/db/user.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reset subscription token endpoint</name>
  <files>internal/api/users.go, internal/api/routes.go</files>
  <action>
Add POST /api/users/:id/reset-subscription:

1. ResetSubscriptionHandler(sm \*scs.SessionManager) http.HandlerFunc
   - RequireAuth
   - Parse id from URL; GetUserByID(id); if not found 404
   - New token := generateSubscriptionToken() (use db package or add to internal/db/user.go)
   - user.SubscriptionToken = token; db.UpdateUser(user)
   - Return 200 with { subscription_url: "/sub/" + token } (path only; frontend builds full URL from origin)
   - Optional: support SUB_URL_PREFIX env for full URL when set (e.g. https://panel.example.com) â€” if env set, return full URL; else return path. Per RESEARCH Open Question 1.

2. routes.go: Add r.Post("/{id}/reset-subscription", ResetSubscriptionHandler(sm)) under /api/users route group.
   </action>
   <verify>curl -X POST /api/users/:id/reset-subscription with auth returns 200; subscription_token in DB updated; old token returns 404 on GET /sub/{old_token}</verify>
   <done>Admin can reset token; old link invalid; new subscription_url returned</done>
   </task>

<task type="auto">
  <name>Task 2: Extend GetUser with subscription_url and subscription_nodes</name>
  <files>internal/api/users.go</files>
  <action>
Extend userItem and GetUserHandler response:

1. userItem struct: add SubscriptionURL string, SubscriptionNodes []struct{Name string, Link string}
2. userFromDB(u \*db.User): set SubscriptionURL = "/sub/" + u.SubscriptionToken when token non-empty
   - If SUB_URL_PREFIX env set: SubscriptionURL = os.Getenv("SUB_URL_PREFIX") + "/sub/" + token
3. userFromDB: set SubscriptionNodes = subscription.GetNodeLinks(u) (from internal/core/subscription)
4. GetUserHandler: already returns userItem; ensure userFromDB is used. Include subscription_url and subscription_nodes in GetUser response (for edit modal). ListUsersHandler: add subscription_url only (lighter payload; nodes only needed in detail).
   </action>
   <verify>GET /api/users/:id returns subscription_url and subscription_nodes; nodes have Name and Link (vless:// or hysteria2://)</verify>
   <done>GetUser response includes subscription_url and subscription_nodes for admin UI</done>
   </task>

</tasks>

<verification>
- go build ./...
- POST /api/users/:id/reset-subscription updates token
- GET /api/users/:id returns subscription_url, subscription_nodes
- Old token no longer works after reset
</verification>

<success_criteria>

- Reset token endpoint works; old link invalid
- GetUser returns subscription_url and subscription_nodes
  </success_criteria>

<output>
After completion, create `.planning/phases/05-subscription-system/05-02-SUMMARY.md`
</output>
