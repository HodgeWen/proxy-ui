---
phase: 05-subscription-system
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - web/package.json
  - web/src/components/users/UserSubscriptionCard.tsx
  - web/src/components/users/UserFormModal.tsx
autonomous: false

must_haves:
  truths:
    - "Admin sees subscription info (username, traffic, expire, nodes) in user detail modal"
    - "Admin can copy subscription link and per-node links"
    - "Admin can display QR code for subscription link (hidden by default, button to expand)"
    - "Admin can reset subscription token from user detail"
  artifacts:
    - path: web/src/components/users/UserSubscriptionCard.tsx
      provides: Dark card with subscription info, nodes, QR, copy
      min_lines: 80
    - path: web/src/components/users/UserFormModal.tsx
      provides: UserSubscriptionCard when editing; reset button
      contains: "UserSubscriptionCard"
  key_links:
    - from: web/src/components/users/UserFormModal.tsx
      to: /api/users
      via: "GetUser returns subscription_url, subscription_nodes"
      pattern: "subscription_url"
    - from: web/src/components/users/UserSubscriptionCard.tsx
      to: "qrcode.react"
      via: "QRCodeSVG component"
      pattern: "QRCode"
---

<objective>
UserSubscriptionCard component with subscription info, per-node copy, QR code (hidden by default), and reset token button; integrated into UserFormModal when editing.

Purpose: SUB-04, SUB-05 — admin sees subscription info in user detail; QR code for subscription link; reset token.
Output: UserSubscriptionCard.tsx, UserFormModal integration, qrcode.react.
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-subscription-system/05-CONTEXT.md
@.planning/phases/05-subscription-system/05-RESEARCH.md
@web/src/components/users/UserFormModal.tsx
@web/src/components/users/UserTable.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install qrcode.react and create UserSubscriptionCard</name>
  <files>web/package.json, web/src/components/users/UserSubscriptionCard.tsx</files>
  <action>
1. pnpm add qrcode.react

2. Create UserSubscriptionCard.tsx:
   - Props: user with subscription_url, subscription_nodes, traffic_used, traffic_limit, expire_at; onReset callback
   - Dark card style (match panel theme): Card with dark bg, border; use existing shadcn Card
   - Display: 用户名, 剩余流量 (X / Y GB or 无限制), 到期时间 (YYYY-MM-DD or 永不过期)
   - 节点列表: map subscription_nodes, each row: node name + Copy button (copy Link to clipboard via toast)
   - 订阅链接: display subscription_url (full URL = window.location.origin + subscription_url when path; else subscription_url if full); Copy 订阅链接 button
   - QR 码: default hidden; "显示 QR 码" button toggles visibility; when visible, render QRCodeSVG from qrcode.react with value = full subscription URL; size ~200px (Claude's discretion)
   - 重置订阅: Button that calls onReset (parent will POST reset and refetch)
   - Responsive layout per CONTEXT
   - Use existing copyToClipboard pattern from UserFormModal (toast.success)
</action>
  <verify>npm run build passes; UserSubscriptionCard renders with mock data</verify>
  <done>UserSubscriptionCard displays subscription info; QR hidden by default; copy buttons work</done>
</task>

<task type="auto">
  <name>Task 2: Integrate UserSubscriptionCard into UserFormModal</name>
  <files>web/src/components/users/UserFormModal.tsx</files>
  <action>
Integrate UserSubscriptionCard into UserFormModal:

1. When user prop is defined (edit mode): render UserSubscriptionCard below form or in a separate section. CONTEXT: "用户详情弹窗内" — subscription info in user detail modal. UserFormModal is the edit/create modal. Show subscription section only when editing (user exists).
2. Pass user data: subscription_url, subscription_nodes, traffic_used, traffic_limit, expire_at. subscription_nodes is only in GetUser response. When modal opens in edit mode, fetch GET /api/users/:id via useQuery (enabled: !!user?.id) to get full user with subscription_nodes. Use this fetched user for UserSubscriptionCard. Form can use list user for initial values per 04-04; subscription card uses fetched data.
3. onReset: async () => { await fetch POST /api/users/:id/reset-subscription; invalidate ["users"]; refetch; toast.success("订阅已重置"); }
</action>
  <verify>Open edit modal; UserSubscriptionCard visible with subscription info; copy and QR work</verify>
  <done>UserSubscriptionCard integrated; edit mode shows subscription section</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify subscription flow</name>
  <files>web/src/components/users/UserFormModal.tsx</files>
  <action>Human verifies full subscription flow: create user with inbound, open edit modal, check subscription section, QR code, copy buttons, reset token.</action>
  <what-built>Full subscription system: token, /sub endpoint, admin API, UserSubscriptionCard with QR and reset</what-built>
  <how-to-verify>
1. Create a user with at least one inbound (VLESS or Hysteria2) that has tls.server_name in config
2. Open user edit modal; see subscription section with link, nodes, copy buttons
3. Click "显示 QR 码"; QR code appears
4. Copy subscription link; open in browser or use curl with token — verify Base64 or Clash response
5. Click "重置订阅"; verify old link returns 404; new link works
6. Copy a per-node link; verify format (vless:// or hysteria2://)
  </how-to-verify>
  <verify>User completes how-to-verify steps.</verify>
  <done>User confirms flow works or reports issues.</done>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- go build ./...
- cd web && pnpm run build
- Checkpoint: human verifies full flow
</verification>

<success_criteria>
- UserSubscriptionCard in UserFormModal (edit mode)
- QR code hidden by default; expand works
- Copy subscription link and per-node links work
- Reset token invalidates old link
</success_criteria>

<output>
After completion, create `.planning/phases/05-subscription-system/05-03-SUMMARY.md`
</output>
