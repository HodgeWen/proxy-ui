---
phase: 08-deployment-production
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - install.sh
autonomous: true

must_haves:
  truths:
    - "curl | bash installs s-ui binary and systemd service"
    - "Script prompts for port and admin password (for setup)"
    - "Subcommands: install, update, uninstall"
  artifacts:
    - path: install.sh
      provides: "Bash install script"
      contains: "install|update|uninstall"
  key_links:
    - from: install.sh
      to: "GitHub releases"
      via: "Download s-ui-linux-{arch}"
      pattern: "github.com.*releases|curl.*s-ui"
    - from: install.sh
      to: "systemd"
      via: "s-ui.service"
      pattern: "systemctl|s-ui.service"
---

<objective>
Create bash install script (curl | bash) that installs s-ui binary only, creates systemd service, supports install/update/uninstall.

Purpose: SYS-04 — bash 安装脚本部署 per CONTEXT.
Output: install.sh
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-deployment-production/08-CONTEXT.md
@.planning/phases/08-deployment-production/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install script core (download, install, systemd)</name>
  <files>install.sh</files>
  <action>
Create install.sh:
- Shebang: #!/bin/bash. set -e. Require root: [[ $EUID -ne 0 ]] && echo "请使用 root 运行" && exit 1.
- Subcommand: case "${1:-install}" in install) ... update) ... uninstall) ... *) echo "用法: install | update | uninstall" ;; esac. Per CONTEXT: install (default), update, uninstall.
- arch(): case "$(uname -m)" in x86_64|amd64) echo amd64;; aarch64|arm64) echo arm64;; *) echo "不支持的架构"; exit 1;; esac.
- INSTALL_DIR=/usr/local/s-ui per RESEARCH.
- install: Fetch latest release tag from api.github.com/repos/s-ui/s-ui/releases/latest (or github.com/OWNER/REPO - use actual repo). Download https://github.com/OWNER/REPO/releases/download/${tag}/s-ui-linux-$(arch). Create INSTALL_DIR. Move binary to INSTALL_DIR/s-ui. chmod +x. Create data dir INSTALL_DIR/data. Create config if not exists (Task 2).
- systemd: Create /etc/systemd/system/s-ui.service with ExecStart=INSTALL_DIR/s-ui, WorkingDirectory=INSTALL_DIR, Environment=CONFIG_PATH=INSTALL_DIR/config.json, Environment=DATA_DIR=INSTALL_DIR/data. Restart=on-failure. systemctl daemon-reload, systemctl enable s-ui.
- Binary naming: s-ui-linux-amd64, s-ui-linux-arm64 per CONTEXT.
- Repo: Use github.com/s-ui/s-ui or derive from script location. Hardcode for now: GITHUB_REPO="s-ui/s-ui" or similar.
</action>
  <verify>./install.sh install (as root or in container) downloads and installs; systemctl status s-ui shows service</verify>
  <done>Install downloads s-ui binary, installs to /usr/local/s-ui, creates systemd service</done>
</task>

<task type="auto">
  <name>Task 2: Interactive prompts and update/uninstall</name>
  <files>install.sh</files>
  <action>
Interactive prompts per CONTEXT:
- Port: read -p "监听端口 [8080]: " port; port=${port:-8080}. Validate numeric. Check port in use: ss -ltn | grep -q ":${port} " && echo "端口已被占用" && exit 1. Or use is_port_in_use helper. Write addr to config: addr=":${port}".
- Admin password: read -p "管理员密码 (首次访问 /setup 时设置，留空跳过): " -s admin_pass. If non-empty, we could pre-create admin... but CONTEXT says "管理员密码" - at setup. So we just prompt to remind user to visit /setup. Or: "安装完成后请访问 http://IP:PORT/setup 设置管理员密码"。So no pre-create; just prompt for port. Skip admin password in install (user sets at /setup). CONTEXT says "提示用户输入端口、管理员密码等" — "等" suggests optional. Port is essential. Admin password: user sets at /setup. So we prompt: "安装完成后访问 http://$(hostname -I|awk '{print $1}'):${port}/setup 设置管理员密码" or similar.
- Config: Create INSTALL_DIR/config.json if not exists. Use panel config schema: addr, session_secret (random), data_dir, singbox_config_path, singbox_binary_path. addr=":${port}". data_dir=INSTALL_DIR/data. singbox_config_path=INSTALL_DIR/sing-box.json. singbox_binary_path="" (user installs sing-box or uses panel to download).

update: Download latest s-ui binary, stop service, replace binary, start service. systemctl stop s-ui, curl download, mv to INSTALL_DIR/s-ui, chmod +x, systemctl start s-ui.
uninstall: systemctl stop s-ui, systemctl disable s-ui, rm -rf INSTALL_DIR, rm /etc/systemd/system/s-ui.service, systemctl daemon-reload. Optionally prompt: "是否删除数据目录? (y/N)".
</action>
  <verify>install with port 9090 creates config with addr ":9090"; update replaces binary; uninstall removes service and files</verify>
  <done>Interactive port prompt; update and uninstall work</done>
</task>

</tasks>

<verification>
- ./install.sh install runs (as root, or in privileged container)
- Service created and enabled
- update replaces binary
- uninstall removes service and files
</verification>

<success_criteria>
- curl | bash installs s-ui
- systemd service;开机自启
- install/update/uninstall subcommands
</success_criteria>

<output>
After completion, create `.planning/phases/08-deployment-production/08-03-SUMMARY.md`
</output>
