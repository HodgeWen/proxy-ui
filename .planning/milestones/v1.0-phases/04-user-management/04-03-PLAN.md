---
phase: 04-user-management
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - web/src/pages/Users.tsx
  - web/src/components/users/UserTable.tsx
  - web/src/components/users/UserFormModal.tsx
  - web/src/components/layout/Sidebar.tsx
  - web/src/routes.tsx
autonomous: true

must_haves:
  truths:
    - "Users page shows table with user list"
    - "Create/edit in UserFormModal with name, remark, inbound multi-select, traffic limit, expire"
    - "UUID and password read-only + copy button when editing"
    - "Table has row checkbox and header checkbox for batch select"
  artifacts:
    - path: web/src/pages/Users.tsx
      provides: Users page with table, add/edit/delete
      contains: "useQuery"
    - path: web/src/components/users/UserFormModal.tsx
      provides: Create/edit form with inbound multi-select
      contains: "react-hook-form"
    - path: web/src/components/users/UserTable.tsx
      provides: User table with checkbox
      contains: "Checkbox"
  key_links:
    - from: web/src/pages/Users.tsx
      to: /api/users
      via: "fetch in useQuery"
      pattern: "fetch.*api/users"
    - from: web/src/components/users/UserFormModal.tsx
      to: /api/users
      via: "fetch POST/PUT"
      pattern: "fetch.*api/users"
---

<objective>
Users page with table and UserFormModal; checkbox for batch select; inbound multi-select per CONTEXT.

Purpose: Admin can create, edit, delete users and assign nodes via modal; prepare for batch UI in Plan 04.
Output: Users.tsx, UserTable, UserFormModal, routes, Sidebar enabled
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-user-management/04-CONTEXT.md
@.planning/phases/04-user-management/04-RESEARCH.md
@web/src/pages/Inbounds.tsx
@web/src/components/inbounds/InboundFormModal.tsx
@web/src/components/certificates/CertificateFormModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Users page and UserTable</name>
  <files>web/src/pages/Users.tsx, web/src/components/users/UserTable.tsx, web/src/components/layout/Sidebar.tsx, web/src/routes.tsx</files>
  <action>
1. Install shadcn components: `cd web && bunx shadcn@latest add checkbox popover badge` (no defaults, accept prompts)

2. Create UserTable.tsx (follow InboundTable/CertificateTable pattern):
   - Props: users[], onEdit(id), onDelete(id), selectedIds, onSelectionChange(ids), isLoading
   - Columns: checkbox (row), 名称, 备注, 状态, 流量, 到期, 节点, 操作
   - Status: Badge 启用/禁用; show 过期 when ExpireAt passed, 超限 when TrafficLimit>0 and TrafficUsed>=TrafficLimit
   - Traffic: "2.3 / 10 GB (23%)" format per CONTEXT; "无限制" when TrafficLimit=0
   - Expire: YYYY-MM-DD from expire_at per CONTEXT; "永不过期" when null
   - 节点: comma-separated inbound tags (need inbound names - fetch inbounds or include in API)
   - 操作: Edit button inline, Delete in DropdownMenu per Phase 2 pattern
   - Header checkbox: "全选当前页" per CONTEXT
   - Row checkbox: controlled by selectedIds

3. Users.tsx: useQuery ["users"] fetch /api/users, render UserTable, Add button opens form
   - State: formOpen, editingId, selectedIds (for batch - Plan 04 wires actions)
   - onEdit, onDelete handlers; window.confirm for delete per Phase 2

4. Sidebar: set users nav disabled: false
5. routes.tsx: add path "users" -> Users
  </action>
  <verify>npm run build in web/ passes; visit /users shows table</verify>
  <done>Users page renders; table shows data; checkbox per row and header</done>
</task>

<task type="auto">
  <name>Task 2: UserFormModal</name>
  <files>web/src/components/users/UserFormModal.tsx, web/src/pages/Users.tsx</files>
  <action>
Create UserFormModal (follow InboundFormModal, CertificateFormModal patterns):

1. Props: open, onOpenChange, user?: UserForEdit, onSuccess
2. Form fields (react-hook-form + zod):
   - name (required), remark (optional)
   - inbound_ids: number[] - multi-select via Popover + Checkbox list
   - traffic_limit: number (0 = unlimited), expire_at: date string (optional)
3. Inbound multi-select: Popover with list of checkboxes; fetch GET /api/inbounds for options; display tag as label
4. When editing: show UUID and Password as read-only Input with copy button (navigator.clipboard.writeText)
5. Create: POST /api/users; Update: PUT /api/users/:id
6. On success: toast, onSuccess(), onOpenChange(false)
7. API returns inbound_ids; form needs to populate. GET /api/users/:id returns user with inbound_ids.

Wire UserFormModal in Users.tsx: open on Add or Edit; fetch user for edit via useQuery when editingId set.
  </action>
  <verify>Create user, edit user, UUID copy works; inbound selection persists</verify>
  <done>UserFormModal create/edit works; UUID/password copy when editing</done>
</task>

</tasks>

<verification>
- web build passes
- Users page loads, table displays
- Create, edit, delete user flow works
- Inbound multi-select and UUID copy functional
</verification>

<success_criteria>
- Full user CRUD from UI
- Traffic/expire display per CONTEXT format
- Batch checkbox ready for Plan 04
</success_criteria>

<output>
After completion, create `.planning/phases/04-user-management/04-03-SUMMARY.md`
</output>
