---
phase: 04-user-management
plan: 04
type: execute
wave: 4
depends_on: ["04-03"]
files_modified:
  - web/src/pages/Users.tsx
  - web/src/components/users/UserTable.tsx
  - web/src/components/users/BatchActionBar.tsx
autonomous: false

must_haves:
  truths:
    - "Search input filters user list by keyword"
    - "Batch action bar appears when users selected"
    - "Batch delete shows confirmation; batch enable/disable/reset_traffic work"
    - "Toast + list refresh after batch operations"
  artifacts:
    - path: web/src/pages/Users.tsx
      provides: Search input, batch bar integration
      contains: "queryKey.*q"
    - path: web/src/components/users/BatchActionBar.tsx
      provides: Batch actions UI
      contains: "删除|启用|禁用|流量重置"
  key_links:
    - from: web/src/pages/Users.tsx
      to: /api/users
      via: "query param q in fetch"
      pattern: "q=|keyword"
    - from: web/src/components/users/BatchActionBar.tsx
      to: /api/users/batch
      via: "fetch POST"
      pattern: "api/users/batch"
---

<objective>
Search/filter and batch operations UI; human verification of full user management flow.

Purpose: USR-08 keyword search; USR-09 batch delete, enable/disable, reset traffic per CONTEXT.
Output: Search input, BatchActionBar, checkpoint verification
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-user-management/04-CONTEXT.md
@.planning/phases/04-user-management/04-RESEARCH.md
@web/src/pages/Users.tsx
@web/src/components/users/UserTable.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Search and batch bar</name>
  <files>web/src/pages/Users.tsx, web/src/components/users/BatchActionBar.tsx</files>
  <action>
1. Search: Add search input above table in Users.tsx. Store search query in state (e.g. searchQ). Include in useQuery key: ["users", searchQ]. Pass searchQ as query param ?q= to fetch. Preserve params on mutation invalidation - invalidate ["users", searchQ] so filter is preserved per RESEARCH Pitfall 5.

2. BatchActionBar: Create component that appears when selectedIds.length > 0. Props: selectedCount, onDelete, onEnable, onDisable, onResetTraffic, onClearSelection.
   - Buttons: 删除, 启用, 禁用, 流量重置
   - Delete: window.confirm("确定删除 N 个用户？") per CONTEXT; on confirm call onDelete
   - Others: call directly
   - Parent passes handlers that POST /api/users/batch with {action, ids}, then invalidate queries, toast.success, clear selectedIds

3. Wire BatchActionBar in Users.tsx: render when selectedIds.length > 0, pass selectedIds to handlers
  </action>
  <verify>Search filters list; batch bar appears when selecting; batch actions execute</verify>
  <done>Search works; batch bar with delete/enable/disable/reset_traffic</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify user management flow</name>
  <files>N/A (human verification)</files>
  <action>Human performs verification steps in how-to-verify below. No code changes.</action>
  <verify>User completes all 9 verification steps and responds with "approved" or raises issues</verify>
  <done>Phase 4 success criteria confirmed by human</done>
  <what-built>Complete Phase 4: User CRUD, node assignment, traffic/expire, search, batch operations</what-built>
  <how-to-verify>
1. Start app (backend + frontend), login
2. Visit /users - table loads
3. Add user: click 添加, fill name, remark, select one or more inbounds, set traffic limit (e.g. 10 GB), set expire date, save - user appears
4. Edit user: click Edit, change fields, save - changes persist
5. Copy UUID: in edit form, click copy - UUID copied to clipboard
6. Search: type keyword in search - list filters
7. Batch: select 2+ users with checkbox, batch bar appears; click 禁用 - users disabled; click 启用 - users enabled
8. Batch delete: select users, click 删除, confirm - users removed, list refreshes
9. Batch reset traffic: select user with traffic_used > 0, click 流量重置 - traffic resets to 0
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- Search preserves filter after batch action (TanStack Query key includes q)
- Batch operations complete with toast and refresh
</verification>

<success_criteria>
- All Phase 4 success criteria from ROADMAP met
- Search and batch operations functional
</success_criteria>

<output>
After completion, create `.planning/phases/04-user-management/04-04-SUMMARY.md`
</output>
