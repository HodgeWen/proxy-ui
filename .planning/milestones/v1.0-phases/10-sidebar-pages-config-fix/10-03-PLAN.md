---
phase: 10-sidebar-pages-config-fix
plan: 03
type: execute
wave: 2
depends_on: [10-01, 10-02]
files_modified:
  - web/src/pages/Core.tsx
  - web/src/pages/Dashboard.tsx
  - web/src/components/layout/Sidebar.tsx
  - web/src/routes.tsx
autonomous: true
requirements: [UX-01, UX-02, UX-05]

must_haves:
  truths:
    - "Core page has all core management features: status, restart, update, rollback, version list, config file viewer"
    - "Dashboard shows real statistics: inbound count, user count, active users, total uplink, total downlink"
    - "Dashboard no longer has any core management UI (status card, restart, update, rollback, versions)"
    - "Sidebar shows all 7 nav items enabled (no disabled items)"
    - "Logout button is in the sidebar footer, visible from every page"
    - "Routes /subscriptions, /traffic, /core are registered and navigate to correct pages"
  artifacts:
    - path: "web/src/pages/Core.tsx"
      provides: "Core management page (migrated from Dashboard)"
      min_lines: 150
    - path: "web/src/pages/Dashboard.tsx"
      provides: "Stats overview dashboard"
      contains: "stats/summary"
    - path: "web/src/components/layout/Sidebar.tsx"
      provides: "Sidebar with all items enabled + logout footer"
      contains: "SidebarFooter"
    - path: "web/src/routes.tsx"
      provides: "All routes including subscriptions, traffic, core"
      contains: "subscriptions"
  key_links:
    - from: "web/src/pages/Core.tsx"
      to: "/api/core/status"
      via: "useQuery fetch"
      pattern: "fetch.*api/core/status"
    - from: "web/src/pages/Core.tsx"
      to: "/api/core/config-file"
      via: "useQuery fetch"
      pattern: "fetch.*api/core/config-file"
    - from: "web/src/pages/Dashboard.tsx"
      to: "/api/stats/summary"
      via: "useQuery fetch"
      pattern: "fetch.*api/stats/summary"
    - from: "web/src/components/layout/Sidebar.tsx"
      to: "/api/logout"
      via: "fetch POST in handleLogout"
      pattern: "fetch.*api/logout"
    - from: "web/src/routes.tsx"
      to: "web/src/pages/Core.tsx"
      via: "route element"
      pattern: "path.*core.*element.*Core"
---

<objective>
Create the Core management page (migrated from Dashboard), refactor Dashboard into a stats overview, enable all sidebar items with logout, and wire up all routes.

Purpose: This is the integration plan that brings together the backend endpoints (Plan 01) and new pages (Plan 02) into a cohesive navigation experience. The Dashboard becomes a clean stats overview, core management moves to its dedicated page, and the sidebar becomes fully functional.

Output: Core.tsx page, refactored Dashboard.tsx, updated Sidebar.tsx with logout, routes.tsx with all 7 routes.
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-sidebar-pages-config-fix/10-CONTEXT.md
@.planning/phases/10-sidebar-pages-config-fix/10-01-SUMMARY.md
@.planning/phases/10-sidebar-pages-config-fix/10-02-SUMMARY.md

@web/src/pages/Dashboard.tsx
@web/src/components/layout/Sidebar.tsx
@web/src/routes.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Core page with full core management + config viewer</name>
  <files>web/src/pages/Core.tsx</files>
  <action>
**web/src/pages/Core.tsx (NEW FILE):**
Migrate ALL core management functionality from Dashboard.tsx to this dedicated page. This is a move, not a copy — Dashboard.tsx will be stripped in Task 2.

The Core page includes everything currently in Dashboard related to sing-box management:

**Section 1: sing-box 状态与版本 (from Dashboard)**
Move these pieces from Dashboard.tsx:
- Types: `CoreStatus`, `Release`, `VersionsResponse`
- Fetch functions: `fetchStatus`, `fetchVersions`, `restartCore`, `updateCore`, `rollbackCore`
- State: `errorModalOpen`, `errorDetail`, `updateConfirmOpen`, `rollbackConfirmOpen`, `versionsListOpen`
- Queries: `useQuery(["core", "status"])` with 5s refetch, `useQuery(["core", "versions"])`
- Mutations: `restartMutation`, `updateMutation`, `rollbackMutation`
- UI: The sing-box status card content (running indicator, versions, restart/update/rollback buttons)
- Dialogs: update confirm, rollback confirm, versions list, error detail

Reorganize on the Core page as a full-page layout (not a card in a grid):
- Header: `<h1>核心管理</h1>`
- Status section: running/stopped indicator with dot, current version, latest version, "有新版本" badge
- Action buttons row: 重启, 更新, 回滚
- "查看所有版本" link → versions list dialog (same dialog)
- All confirm/error dialogs remain the same

**Section 2: 配置文件查看 (NEW)**
Add a config file viewer section below the status section:
- `useQuery({ queryKey: ["core", "config-file"], queryFn: ... })` fetching `GET /api/core/config-file`
- On success: display the JSON in a `<pre>` block with `JSON.stringify(JSON.parse(data), null, 2)` for pretty formatting
- On 404: show "暂无配置文件 — 添加入站后自动生成" empty state
- On error: show error message
- Wrap in a Card with title "sing-box 配置文件" and description "当前生成的 sing-box 配置（只读）"
- The `<pre>` block should have: `bg-muted rounded-lg p-4 text-sm font-mono overflow-auto max-h-[60vh] whitespace-pre-wrap`

Page layout: `p-6 space-y-6`. Use the same imports pattern as other pages (useQuery, useMutation, Card, Dialog, Badge, Button, toast).
  </action>
  <verify>
`cd web && npx tsc --noEmit` — no TypeScript errors. `web/src/pages/Core.tsx` exists and exports `Core`. File contains: fetchStatus, fetchVersions, restartCore, updateCore, rollbackCore, and a fetch to `/api/core/config-file`.
  </verify>
  <done>
Core.tsx is a complete core management page with: status/version display, restart/update/rollback with confirm dialogs, version list modal, error detail modal, and read-only config file viewer. All functionality migrated from Dashboard.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor Dashboard, update Sidebar, wire routes</name>
  <files>
    web/src/pages/Dashboard.tsx
    web/src/components/layout/Sidebar.tsx
    web/src/routes.tsx
  </files>
  <action>
**web/src/pages/Dashboard.tsx — MAJOR REFACTOR:**
Strip ALL core management code and replace with stats overview.

Remove:
- All core-related types (CoreStatus, Release, VersionsResponse)
- All core fetch functions (fetchStatus, fetchVersions, restartCore, updateCore, rollbackCore)
- All core state variables (errorModalOpen, errorDetail, updateConfirmOpen, rollbackConfirmOpen, versionsListOpen, updateAvailable, latestStable, etc.)
- All core queries and mutations
- All core UI (the sing-box status/version card, all dialogs)
- The handleLogout function and the logout button (moving to Sidebar)
- The hardcoded "入站数=0, 用户数=0" placeholder cards

Replace with:
1. `useQuery({ queryKey: ["stats", "summary"], queryFn: ... })` fetching `GET /api/stats/summary`
   - Returns: `{ inbound_count, user_count, active_user_count, total_uplink, total_downlink }`
2. Stats overview grid (3 columns on lg, 1 on mobile):
   - Card: 入站数 — show `inbound_count` as large number, with Radio icon
   - Card: 用户数 — show `user_count` as large number, with `active_user_count` as subtitle "活跃 N", with Users icon
   - Card: 总流量 — show total_uplink "上行" and total_downlink "下行" using `formatBytes` from `@/lib/format`, with Gauge icon (or ArrowUpDown)
3. Page header: just `<h1>仪表盘</h1>` (no logout button — it's in sidebar now)
4. Loading state: Skeleton cards
5. Error state: "获取统计数据失败" with retry

The resulting Dashboard.tsx should be much simpler — ~80-100 lines instead of ~430.

**web/src/components/layout/Sidebar.tsx:**
1. Remove `disabled: true` from all three nav items:
   - `{ to: "/subscriptions", label: "订阅", icon: Link2 }` (remove disabled)
   - `{ to: "/traffic", label: "流量", icon: Gauge }` (remove disabled)
   - `{ to: "/core", label: "核心", icon: Box }` (remove disabled)
2. Remove the `disabled` field from the navItems type and the `disabled={item.disabled ?? false}` prop and `pointer-events-none opacity-50` className logic
3. Add SidebarFooter with logout button:
   - Import `SidebarFooter` from `@/components/ui/sidebar`
   - Import `LogOut` from `lucide-react`
   - Import `useNavigate` from `react-router-dom`
   - Add after `</SidebarContent>`:
   ```tsx
   <SidebarFooter className="p-4">
     <Button variant="ghost" size="sm" className="w-full justify-start gap-2" onClick={handleLogout}>
       <LogOut className="size-4" />
       <span>退出登录</span>
     </Button>
   </SidebarFooter>
   ```
   - Import `Button` from `@/components/ui/button`
   - Add handleLogout function:
   ```tsx
   const navigate = useNavigate()
   const handleLogout = async () => {
     await fetch("/api/logout", { method: "POST", credentials: "include" })
     navigate("/login", { replace: true })
   }
   ```

**web/src/routes.tsx:**
1. Add imports for the three new pages:
   ```tsx
   import { Subscriptions } from './pages/Subscriptions'
   import { Traffic } from './pages/Traffic'
   import { Core } from './pages/Core'
   ```
2. Add routes inside the `children` array of the authenticated layout:
   ```tsx
   { path: "subscriptions", element: <Subscriptions /> },
   { path: "traffic", element: <Traffic /> },
   { path: "core", element: <Core /> },
   ```
  </action>
  <verify>
`cd web && npx tsc --noEmit` — no TypeScript errors. `rg 'fetchStatus|fetchVersions|restartCore|updateCore|rollbackCore' web/src/pages/Dashboard.tsx` — zero matches (core code removed). `rg 'disabled.*true' web/src/components/layout/Sidebar.tsx` — zero matches (all enabled). `rg 'SidebarFooter' web/src/components/layout/Sidebar.tsx` — found (logout added). `rg 'subscriptions|traffic|core' web/src/routes.tsx` — all three routes found.
  </verify>
  <done>
Dashboard shows real stats from /api/stats/summary (inbound count, user count, traffic totals). No core management UI remains in Dashboard. Sidebar has all 7 items enabled + logout button in footer. Routes registered for /subscriptions, /traffic, /core.
  </done>
</task>

</tasks>

<verification>
1. `cd web && npx tsc --noEmit` — zero errors
2. Navigate to `/core` — shows sing-box status, restart/update/rollback, config viewer
3. Navigate to `/` (dashboard) — shows stats cards with real data, no core management
4. Navigate to `/subscriptions` — shows subscription list (from Plan 02)
5. Navigate to `/traffic` — shows tabbed traffic view (from Plan 02)
6. Sidebar — all 7 items clickable, logout button at bottom
7. `rg 'handleLogout' web/src/pages/Dashboard.tsx` — zero matches (moved to Sidebar)
</verification>

<success_criteria>
- Core.tsx is fully functional with all core management features + config viewer
- Dashboard.tsx is a clean stats overview (~80-100 lines, not ~430)
- Sidebar has no disabled items and has logout in footer
- All 7 sidebar routes work and navigate to correct pages
- No duplicate code between Dashboard and Core (clean migration)
</success_criteria>

<output>
After completion, create `.planning/phases/10-sidebar-pages-config-fix/10-03-SUMMARY.md`
</output>
