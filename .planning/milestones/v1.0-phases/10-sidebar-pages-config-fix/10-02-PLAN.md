---
phase: 10-sidebar-pages-config-fix
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - web/src/pages/Subscriptions.tsx
  - web/src/pages/Traffic.tsx
  - web/src/components/ui/tabs.tsx
autonomous: true
requirements: [UX-01, UX-02]

must_haves:
  truths:
    - "Subscriptions page renders a list of users with: username, subscription link, status badge (活跃/过期/超限/禁用)"
    - "User can copy subscription link and view QR code from Subscriptions page"
    - "Traffic page shows two tabs: 按入站 and 按用户, each with a data table"
    - "Traffic page has overview cards at top: total uplink, total downlink, active user count"
  artifacts:
    - path: "web/src/pages/Subscriptions.tsx"
      provides: "Read-only subscription overview page"
      min_lines: 80
    - path: "web/src/pages/Traffic.tsx"
      provides: "Tabbed traffic aggregation page with overview cards"
      min_lines: 100
    - path: "web/src/components/ui/tabs.tsx"
      provides: "shadcn Tabs component"
  key_links:
    - from: "web/src/pages/Subscriptions.tsx"
      to: "/api/users"
      via: "useQuery fetch"
      pattern: "fetch.*api/users"
    - from: "web/src/pages/Traffic.tsx"
      to: "/api/inbounds"
      via: "useQuery fetch"
      pattern: "fetch.*api/inbounds"
    - from: "web/src/pages/Traffic.tsx"
      to: "/api/users"
      via: "useQuery fetch"
      pattern: "fetch.*api/users"
---

<objective>
Create the Subscriptions and Traffic pages as standalone page components. These pages exist independently of the backend changes (they use existing API endpoints).

Purpose: Enable the three disabled sidebar pages. Subscriptions provides a read-only subscription overview. Traffic provides tabbed aggregated traffic view with overview cards.

Output: Two new page components (Subscriptions.tsx, Traffic.tsx) plus shadcn Tabs component installed.
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-sidebar-pages-config-fix/10-CONTEXT.md

@web/src/pages/Users.tsx
@web/src/components/users/UserTable.tsx
@web/src/components/users/UserSubscriptionModal.tsx
@web/src/components/users/UserSubscriptionCard.tsx
@web/src/components/inbounds/InboundTable.tsx
@web/src/pages/Inbounds.tsx
@web/src/lib/format.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn Tabs and create Subscriptions page</name>
  <files>
    web/src/components/ui/tabs.tsx
    web/src/pages/Subscriptions.tsx
  </files>
  <action>
**Install Tabs component:**
Run `cd web && npx shadcn@latest add tabs -y` to generate the Tabs component. This uses @radix-ui/react-tabs which is already in the lockfile.

**web/src/pages/Subscriptions.tsx (NEW FILE):**
Create a read-only subscription overview page. Design decisions (per Claude's Discretion):
- Position as "用户订阅概览" — a flat list of all users with their subscription info
- UserSubscriptionModal from Phase 5 stays as the quick-access entry from Users page

Implementation:
1. `useQuery({ queryKey: ["users"], queryFn: ... })` fetching `GET /api/users` (same as Users page)
2. Derive status for each user using the same logic as UserTable's `getStatusBadge`:
   - `!enabled` → 禁用 (gray)
   - `expire_at && new Date(expire_at) < now` → 过期 (red)
   - `traffic_limit > 0 && traffic_used >= traffic_limit` → 超限 (amber)
   - else → 活跃 (green)
3. Page layout:
   - `<h1>订阅</h1>` header
   - Table with columns: 用户名, 订阅链接 (truncated with copy button), 状态 (Badge), 操作 (QR button)
   - Each row: user.name, subscription_url (if empty show "—"), status badge, actions
4. Copy link: onClick copies `subscription_url` to clipboard via `navigator.clipboard.writeText`, toast "已复制"
5. QR code: clicking QR button opens a Dialog showing QRCodeSVG from `qrcode.react` for the subscription_url
6. Handle loading state with skeleton/spinner. Handle empty state with "暂无用户" message.
7. Use `refetchInterval: 60000` for freshness.

Follow existing page patterns: same padding (`p-6 space-y-6`), same table styling as InboundTable/UserTable, same Badge variants. Import `formatBytes` from `@/lib/format` for traffic display if needed. Use shadcn Table components (Table, TableHeader, TableRow, TableHead, TableBody, TableCell) for consistency.
  </action>
  <verify>
`cd web && npx tsc --noEmit` — no TypeScript errors. `web/src/components/ui/tabs.tsx` exists (shadcn installed). `web/src/pages/Subscriptions.tsx` exists and exports `Subscriptions`.
  </verify>
  <done>
Subscriptions page renders user subscription list with name, truncated link + copy button, status badge (活跃/过期/超限/禁用), and QR code dialog. shadcn Tabs component installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Traffic page with tabs and overview cards</name>
  <files>web/src/pages/Traffic.tsx</files>
  <action>
**web/src/pages/Traffic.tsx (NEW FILE):**
Create the traffic aggregation page with tab layout per user decision.

Implementation:
1. Two `useQuery` calls: `GET /api/inbounds` and `GET /api/users` for table data
2. Compute overview stats client-side from the fetched data (the /api/stats/summary endpoint from Plan 01 may not be ready — use client-side computation as fallback; the Traffic page works with existing data regardless):
   - Total uplink: sum of all inbound traffic_uplink
   - Total downlink: sum of all inbound traffic_downlink
   - Active users: count of users where enabled=true and not expired and not over limit
3. Overview cards at top (3 cards in a grid):
   - Card 1: 总上行 / 总下行 (using `formatBytes` from `@/lib/format`)
   - Card 2: 活跃用户 count
   - Card 3: 入站数 count
4. Tabs component below cards:
   - Tab "按入站": Table with columns — 标签(tag), 协议(protocol), 上行(traffic_uplink), 下行(traffic_downlink)
   - Tab "按用户": Table with columns — 用户名(name), 上行(traffic_uplink), 下行(traffic_downlink), 状态(status badge)
5. Use `formatBytes` for all traffic values
6. Use `refetchInterval: 60000` for both queries
7. Use shadcn Tabs (TabsList, TabsTrigger, TabsContent), Card, Table components
8. Loading state: skeleton for cards, spinner for tables
9. Empty state: "暂无入站" / "暂无用户" when lists are empty

Follow dark theme conventions: same card styling as Dashboard, same table patterns as InboundTable/UserTable. Page layout: `p-6 space-y-6`.
  </action>
  <verify>
`cd web && npx tsc --noEmit` — no TypeScript errors. `web/src/pages/Traffic.tsx` exists and exports `Traffic`. File uses Tabs, TabsList, TabsTrigger, TabsContent from `@/components/ui/tabs`.
  </verify>
  <done>
Traffic page renders overview cards (总上行/下行, 活跃用户, 入站数) and two tabs (按入站 table, 按用户 table) using existing API data with formatBytes and 60s refresh.
  </done>
</task>

</tasks>

<verification>
1. `cd web && npx tsc --noEmit` — zero errors
2. `web/src/pages/Subscriptions.tsx` exists, exports `Subscriptions`
3. `web/src/pages/Traffic.tsx` exists, exports `Traffic`
4. `web/src/components/ui/tabs.tsx` exists (shadcn Tabs installed)
5. Both pages fetch from existing API endpoints (no new backend dependency for basic operation)
</verification>

<success_criteria>
- Subscriptions.tsx shows user subscription list (name, link, status, QR)
- Traffic.tsx shows tabbed traffic view with overview cards
- Both pages follow existing dark theme and component patterns
- TypeScript compiles cleanly
- Pages are self-contained components ready to be routed in Plan 03
</success_criteria>

<output>
After completion, create `.planning/phases/10-sidebar-pages-config-fix/10-02-SUMMARY.md`
</output>
