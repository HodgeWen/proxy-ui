---
phase: 09-certificate-config-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/api/certs.go
  - internal/api/routes.go
autonomous: true

must_haves:
  truths:
    - "UpdateCertificateHandler 在更新证书后自动执行 Generate -> ApplyConfig -> Restart"
    - "ApplyConfig 失败时证书更新回滚并返回 400 JSON 错误"
  artifacts:
    - path: internal/api/certs.go
      provides: "UpdateCertificateHandler with panelCfg, Generate, ApplyConfig, Restart, rollback"
      contains: "UpdateCertificateHandler(sm *scs.SessionManager, panelCfg *config.Config)"
    - path: internal/api/routes.go
      provides: "routes pass cfg to UpdateCertificateHandler"
      contains: "UpdateCertificateHandler(sm, cfg)"
  key_links:
    - from: internal/api/certs.go
      to: internal/core
      via: "ConfigGenerator.Generate, ApplyConfig, NewProcessManagerFromConfig"
      pattern: "core\.(ConfigGenerator|ApplyConfig|NewProcessManagerFromConfig)"
---

<objective>
将 UpdateCertificateHandler 接上 Generate -> ApplyConfig -> Restart 链路，闭环审计缺口 Cert update -> Generate -> Apply。

Purpose: 证书路径更新后，引用该证书的入站立即生效，无需额外入站/用户变更触发。
Output: certs.go 中 UpdateCertificateHandler 实现完整 Mutate -> Generate -> Apply -> Restart 流程；routes.go 传入 panelCfg。
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-certificate-config-sync/09-RESEARCH.md
@.planning/v1.0-MILESTONE-AUDIT.md
@internal/api/inbounds.go
@internal/api/certs.go
@internal/api/routes.go
@internal/api/core.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: UpdateCertificateHandler 接入 Generate/Apply/Restart</name>
  <files>internal/api/certs.go</files>
  <action>
1. 修改 UpdateCertificateHandler 签名：增加参数 `panelCfg *config.Config`，与 UpdateInboundHandler 一致。
2. 在 db.UpdateCertificate(c) 之前，执行 `old, err := db.GetCertificateByID(id)` 保存当前记录用于回滚。
3. 在 db.UpdateCertificate(c) 之后，执行：
   - path := configPath(panelCfg)
   - gen := &core.ConfigGenerator{}
   - cfg, err := gen.Generate()
   - 若 Generate 失败：db.UpdateCertificate(old)，http.Error 500，return
   - 若 core.ApplyConfig(path, cfg) 失败：db.UpdateCertificate(old)，设置 Content-Type application/json，WriteHeader 400，json.Encode(map[string]string{"error": err.Error()})，return
   - pm := core.NewProcessManagerFromConfig(panelCfg)；pm.Restart(path)（best-effort，失败不返回错误）
4. 成功时返回 json.Encode(certFromDB(c)) 与 200。
5. 添加 import：internal/config, internal/core。
6. 引用 @internal/api/inbounds.go UpdateInboundHandler (lines 211–282) 作为模板，保持一致。
</action>
  <verify>
cd /home/whj/codes/s-ui && go build ./...
</verify>
  <done>UpdateCertificateHandler 在执行 db.UpdateCertificate 后调用 Generate -> ApplyConfig -> Restart；ApplyConfig 失败时回滚并返回 400 JSON。</done>
</task>

<task type="auto">
  <name>Task 2: routes.go 传入 panelCfg</name>
  <files>internal/api/routes.go</files>
  <action>
将 r.Put("/{id}", UpdateCertificateHandler(sm)) 改为 r.Put("/{id}", UpdateCertificateHandler(sm, cfg))。
cfg 在 Routes 函数中已传入，与 inbounds 的 CreateInboundHandler/UpdateInboundHandler/DeleteInboundHandler 相同。
</action>
  <verify>
cd /home/whj/codes/s-ui && go build ./...
</verify>
  <done>UpdateCertificateHandler 能收到 panelCfg，可调用 configPath 与 NewProcessManagerFromConfig。</done>
</task>

</tasks>

<verification>
- go build ./... 通过
- PUT /api/certs/:id 更新证书后，sing-box 配置应包含新路径（引用该 cert 的入站）
- 若 ApplyConfig 失败（如 invalid path），证书应回滚，API 返回 400 {"error": "..."}
</verification>

<success_criteria>
1. UpdateCertificateHandler 在更新证书后自动执行 Generate -> ApplyConfig -> Restart
2. ApplyConfig 失败时证书更新回滚，API 返回 400 {"error": err.Error()}
</success_criteria>

<output>
After completion, create `.planning/phases/09-certificate-config-sync/09-01-SUMMARY.md`
</output>
