---
phase: 09-certificate-config-sync
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - web/src/components/certificates/CertificateFormModal.tsx
autonomous: true

must_haves:
  truths:
    - "证书更新 ApplyConfig 失败时，前端显示 sing-box check 输出的错误信息"
  artifacts:
    - path: web/src/components/certificates/CertificateFormModal.tsx
      provides: "400 错误时 checkError 显示（与 InboundFormModal 一致）"
      contains: "checkError"
  key_links:
    - from: web/src/components/certificates/CertificateFormModal.tsx
      to: "/api/certs"
      via: "fetch PUT, 400 时解析 data.error"
      pattern: "res\.status === 400.*data\.error"
---

<objective>
使 CertificateFormModal 在 ApplyConfig 失败（400）时展示 sing-box check 的错误信息，与 InboundFormModal 的 checkError 行为一致。

Purpose: 用户能直接看到配置校验失败的具体原因（如路径无效、证书格式错误），而非仅 toast 提示。
Output: CertificateFormModal 增加 checkError 状态和错误展示区域。
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-certificate-config-sync/09-RESEARCH.md
@web/src/components/certificates/CertificateFormModal.tsx
@web/src/components/inbounds/InboundFormModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: CertificateFormModal 增加 checkError 显示</name>
  <files>web/src/components/certificates/CertificateFormModal.tsx</files>
  <action>
1. 添加 useState: const [checkError, setCheckError] = useState<string | null>(null)
2. 在 open 或 certificate 变化时重置: setCheckError(null)
3. 在 handleSubmit 的 fetch 之后，若 !res.ok：
   - 解析 data = await res.json().catch(() => ({}))
   - 若 res.status === 400 且 data.error：setCheckError(data.error)
   - 否则：toast.error(data.error || "请求失败")
   - 若 400 且 data.error：不 toast，仅展示 checkError
4. 在 form 上方、DialogTitle 下方增加错误展示块（与 InboundFormModal 一致）：
   {checkError && (
     <div className="rounded-lg bg-destructive/10 text-destructive p-3 text-sm">
       <pre className="whitespace-pre-wrap">{checkError}</pre>
     </div>
   )}
5. 在 400 且 data.error 时 return 前不调用 toast.error；其他错误仍用 toast。
</action>
  <verify>
cd /home/whj/codes/s-ui && bun run build
</verify>
  <done>证书更新 ApplyConfig 失败时，Modal 内显示 sing-box check 错误内容，与入站表单一致。</done>
</task>

</tasks>

<verification>
- bun run build 通过
- 手动测试：将证书路径改为无效路径，PUT 后应看到 Modal 内红色错误块展示 check 输出
</verification>

<success_criteria>
ApplyConfig 失败时，前端显示 sing-box check 输出的错误信息，与 InboundFormModal 的 checkError 行为一致。
</success_criteria>

<output>
After completion, create `.planning/phases/09-certificate-config-sync/09-02-SUMMARY.md`
</output>
