---
phase: 03-certificate-management
plan: 03
type: execute
wave: 3
depends_on:
  - "03-02"
files_modified:
  - web/src/components/inbounds/InboundFormModal.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can select a certificate when configuring inbound TLS"
    - "Cert selection and manual paths are mutually exclusive"
  artifacts:
    - path: web/src/components/inbounds/InboundFormModal.tsx
      provides: Cert selector in TLS section
      contains: "选择证书|手动输入|certificate_id"
  key_links:
    - from: web/src/components/inbounds/InboundFormModal.tsx
      to: /api/certs
      via: useQuery for cert list
      pattern: "api/certs"
    - from: buildConfigJson
      to: config_json.tls.certificate_id
      via: form value when cert selected

---

<objective>
Add certificate selector to InboundFormModal TLS section. When TLS type is TLS (VLESS) or protocol is Hysteria2, admin can choose "选择证书" (dropdown) or "手动输入" (inline paths). Selecting cert stores certificate_id in config_json; manual input stores certificate_path/key_path. Mutual exclusivity enforced in form.

Purpose: CRT-02 — admin can associate certificate with inbound TLS options.
Output: InboundFormModal TLS section with cert dropdown; buildConfigJson/parseConfigFromJson handle certificate_id.
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-certificate-management/03-RESEARCH.md
@web/src/components/inbounds/InboundFormModal.tsx
@internal/core/generator.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: InboundFormModal TLS cert selector</name>
  <files>web/src/components/inbounds/InboundFormModal.tsx</files>
  <action>
Add certificate_id and cert_mode to TLS handling:

1. Schema: Add certificate_id: z.number().optional().nullable() to vlessSchema (when tls_type=tls) and hysteria2Schema. Add tls_cert_mode: z.enum(["cert", "manual"]).optional() for UX.

2. Cert list: useQuery({ queryKey: ["certificates"], queryFn: fetchCerts }) where fetchCerts calls GET /api/certs. Use when tls_type==="tls" (VLESS) or protocol==="hysteria2".

3. TLS section UI (VLESS tls_type=tls and Hysteria2):
   - Add "证书" FieldLabel with tooltip "选择已保存的证书或手动输入路径"
   - Select: value = certificate_id ? String(certificate_id) : "manual"
   - Options: SelectItem value="manual" label="手动输入"; then certificates?.map(c => SelectItem value=String(c.id) label=c.name)
   - onValueChange: if "manual" then set certificate_id=null, clear tls_certificate_path/tls_key_path; else set certificate_id=Number(v), set tls_certificate_path="", tls_key_path=""
   - When certificate_id is set: hide inline path inputs. When "manual": show inline path inputs (current certificate_path, key_path)

4. buildConfigJson: when cert selected (certificate_id present and > 0), set config.tls.certificate_id = certificate_id and do NOT set certificate_path/key_path. When manual, set certificate_path/key_path as now.

5. parseConfigFromJson: if tls.certificate_id exists, set certificate_id and tls_cert_mode="cert"; else set tls_cert_mode="manual" and parse certificate_path, key_path.

6. Form reset (useEffect): when parsing inbound, if certificate_id set then clear tls_certificate_path/tls_key_path; when manual, set paths from config. Add tls_cert_mode to defaultValues.

7. Mutual exclusivity: when switching cert, clear paths; when switching manual, clear certificate_id.
</action>
  <verify>cd web && bun run build passes; InboundFormModal TLS section shows cert dropdown when TLS enabled</verify>
  <done>VLESS TLS and Hysteria2 forms show cert selector; selecting cert stores certificate_id; manual mode stores paths; edit loads existing cert_id or paths correctly</done>
</task>

</tasks>

<verification>
- cd web && bun run build
- Manual: add inbound with cert selected, verify config_json has certificate_id; add inbound with manual paths, verify certificate_path/key_path
- Edit existing inbound with cert_id, verify form shows cert selected
</verification>

<success_criteria>
- Admin can associate certificate with inbound TLS via dropdown
- Cert selection and manual paths mutually exclusive
- ConfigGenerator (from Plan 01) resolves certificate_id to paths when building sing-box config
</success_criteria>

<output>
After completion, create `.planning/phases/03-certificate-management/03-03-SUMMARY.md`
</output>
