---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: [01]
files_modified:
  - internal/core/process.go
  - internal/core/config.go
  - internal/api/core.go
  - cmd/server/main.go
  - internal/api/routes.go
autonomous: true

must_haves:
  truths:
    - "面板启动时自动检测并显示 sing-box 版本"
    - "面板可应用配置变更并重启 sing-box 进程"
    - "sing-box check 验证失败时返回错误详情"
  artifacts:
    - path: internal/core/process.go
      provides: Version, Check, IsRunning, Restart
      contains: "Version|Check|IsRunning|Restart"
    - path: internal/core/config.go
      provides: 原子写入配置（temp file + check + rename）
      contains: "Rename|check|temp"
    - path: internal/api/core.go
      provides: GET /api/core/status, POST /api/core/restart, POST /api/core/config
      exports: ["status", "restart", "config"]
  key_links:
    - from: internal/api/core.go
      to: internal/core
      via: ProcessManager / ConfigWriter
      pattern: "core\\.|ProcessManager"
    - from: internal/core/config.go
      to: internal/core/process.go
      via: Check before rename
      pattern: "Check|check"
---

<objective>
实现 sing-box 进程集成：版本检测、配置校验、应用配置、重启进程。面板可调用 API 获取状态、应用配置并重启。

Purpose: 满足 COR-01、COR-02；为 Phase 2 入站管理提供配置应用能力
Output: internal/core/process.go、config.go；GET /api/core/status、POST /api/core/restart、POST /api/core/config
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/research/ARCHITECTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: sing-box process manager</name>
  <files>internal/core/process.go</files>
  <action>
实现 ProcessManager（或等价结构）：
- Version() (string, error): exec "sing-box version" 或 "sing-box version -n"（无颜色便于解析），捕获 stdout，TrimSpace 返回
- Check(configPath string) (output string, err error): exec "sing-box check -c path"，CombinedOutput，失败时返回包含 stderr 的 error
- IsRunning() bool: 检查 sing-box 进程是否存在（可通过 PID 文件或 pgrep/exec 检查）
- Restart(configPath string) error: 停止现有进程 → 启动 "sing-box run -c path"（后台运行）
- 配置路径从环境变量 SINGBOX_CONFIG_PATH 读取，默认 ./config.json；若不存在可返回空版本或特定错误
- 参考 01-RESEARCH.md Pattern 3
  </action>
  <verify>单元测试或手动：在无 sing-box 环境下 Version 返回错或空；有 sing-box 时 Version 返回版本字符串</verify>
  <done>Version、Check、IsRunning、Restart 可用</done>
</task>

<task type="auto">
  <name>Task 2: Config write (temp + atomic rename)</name>
  <files>internal/core/config.go</files>
  <action>
实现安全配置写入：
- ApplyConfig(configPath string, configJSON []byte) error: 写入临时文件 → sing-box check -c tempfile → 若成功则 os.Rename(temp, configPath)；失败时保留原 config，返回 check 输出
- 临时文件置于与 config 同目录，.tmp 后缀，写入后立即 check
- 禁止直接覆盖 config.json；必须通过 temp + check + rename
- 参考 01-RESEARCH.md 与 PITFALLS 中 Config Write Corruption
  </action>
  <verify>写入非法 JSON 或无效 config 时 check 失败，原 config 未被覆盖</verify>
  <done>ApplyConfig 实现 temp-file-check-rename 流程</done>
</task>

<task type="auto">
  <name>Task 3: Core API handlers</name>
  <files>internal/api/core.go, internal/api/routes.go, cmd/server/main.go</files>
  <action>
实现核心 API（需 session 认证）：
- GET /api/core/status: 返回 { running, version, uptime? }。version 来自 Version()；running 来自 IsRunning()；uptime 可选（Phase 1 可暂不实现）
- POST /api/core/restart: 若 config 文件存在则 Restart(configPath)；返回 200 或 500
- POST /api/core/config: Body 为 JSON 配置；调用 ApplyConfig；成功返回 200；失败返回 400/500 及 check 错误输出（用于前端 Modal 展示）
- 路由需经过 auth 中间件（已登录）
- 配置路径从 env 或默认 ./config.json 传入
  </action>
  <verify>curl -X GET /api/core/status 返回 version；POST /api/core/config 接受 JSON 并执行 apply</verify>
  <done>status、restart、config 三个端点可用</done>
</task>

</tasks>

<verification>
- GET /api/core/status 返回 sing-box 版本与运行状态
- POST /api/core/config 接受 JSON，执行 check→rename→restart
- check 失败时返回错误详情供前端 Modal 展示
</verification>

<success_criteria>
1. 面板可获取 sing-box 版本
2. 面板可应用配置变更并重启 sing-box
3. 配置写入使用 temp file + atomic rename
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
