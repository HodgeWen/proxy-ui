---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cmd/server/main.go
  - internal/api/auth.go
  - internal/api/routes.go
  - internal/db/admin.go
  - internal/db/db.go
  - internal/session/session.go
  - web/package.json
  - web/src/main.tsx
  - web/src/App.tsx
  - web/src/pages/Setup.tsx
  - web/src/pages/Login.tsx
  - web/src/routes.tsx
  - embed.go
  - go.mod
  - go.sum
autonomous: true

must_haves:
  truths:
    - "管理员可通过用户名/密码登录面板（首次部署必须设置，无默认密码）"
    - "首次部署时无 admin 则重定向到 /setup"
    - "Setup 完成后可登录"
  artifacts:
    - path: internal/db/admin.go
      provides: Admin model (username, password_hash)
      contains: "Admin"
    - path: internal/api/auth.go
      provides: setup, login, logout endpoints
      exports: ["POST /api/setup", "POST /api/login", "POST /api/logout"]
    - path: web/src/pages/Setup.tsx
      provides: 首次设置表单
      min_lines: 40
    - path: web/src/pages/Login.tsx
      provides: 登录表单（居中卡片，Vercel 风格）
      min_lines: 40
  key_links:
    - from: web/src/pages/Setup.tsx
      to: /api/setup
      via: fetch POST
      pattern: "api/setup"
    - from: web/src/pages/Login.tsx
      to: /api/login
      via: fetch POST
      pattern: "api/login"
    - from: internal/api/auth.go
      to: internal/db
      via: GORM Admin model
      pattern: "db\\.|Admin"
---

<objective>
建立项目脚手架、数据库、会话认证与 Setup/Login 流程，使管理员首次部署可通过 Setup 设置账号，之后通过登录访问面板。

Purpose: 提供认证基础，无默认密码，Session 7 天（支持「记住我」）
Output: 可运行的 Go+React 单体，Setup 页、登录页、Session 中间件、Admin 模型
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/research/STACK.md
@.planning/research/ARCHITECTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project scaffold (Go + React)</name>
  <files>cmd/server/main.go, internal/api/routes.go, internal/db/db.go, web/package.json, web/src/main.tsx, web/src/App.tsx, embed.go, go.mod</files>
  <action>
创建项目骨架：
- Go: cmd/server/main.go 使用 Chi 路由，go:embed 嵌入 web/dist；internal/db/db.go 初始化 GORM + SQLite（内存或 ./data/s-ui.db）；internal/api/routes.go 挂载 /api/* 和静态文件
- 前端: bun create vite@latest web --template react-ts；使用 bun 管理依赖（PROJECT.md 约束）
- 依赖: go get github.com/go-chi/chi/v5 gorm.io/gorm gorm.io/driver/sqlite
- 前端: bun add @tanstack/react-query react-router-dom
- 确保 go build 可编译、bun run build 可产出 web/dist
  </action>
  <verify>cd /home/whj/codes/s-ui && go build ./cmd/server && cd web && bun run build</verify>
  <done>Go 服务可编译，React 可构建，Chi 路由可用</done>
</task>

<task type="auto">
  <name>Task 2: Auth backend (Admin, Session, API)</name>
  <files>internal/db/admin.go, internal/session/session.go, internal/api/auth.go</files>
  <action>
实现认证后端：
- Admin 模型: id, username (unique), password_hash, created_at。GORM AutoMigrate
- Session: alexedwards/scs v2，SQLite store（需 go get github.com/alexedwards/scs/sqlite3store），Lifetime 7d，Cookie HttpOnly/Secure/SameSite=Lax。支持「记住我」：表单传 remember，true 时 Cookie.Persist=true
- Auth API:
  - POST /api/setup: 若已有 admin 返回 400；否则校验 username(3-50)、password(8+)、confirm 一致 → bcrypt 哈希 → 插入 admin → 创建 session → 返回 200
  - POST /api/login: 校验 username/password → bcrypt.Compare → 创建 session（含 remember）→ 返回 200
  - POST /api/logout: 销毁 session → 200
- 中间件: 若 DB 无 admin 且 path != /setup 且 path != /api/setup → 302 /setup；若已登录则 /setup、/login 重定向到 /
  </action>
  <verify>curl -X POST http://localhost:8080/api/setup -H "Content-Type: application/json" -d '{"username":"admin","password":"Test1234!","confirm":"Test1234!"}' 应返回 200；再 curl -X POST /api/login 同 body 应返回 200</verify>
  <done>Setup、Login、Logout 可用；无 admin 时强制 /setup</done>
</task>

<task type="auto">
  <name>Task 3: Auth UI (Setup + Login pages)</name>
  <files>web/src/pages/Setup.tsx, web/src/pages/Login.tsx, web/src/routes.tsx</files>
  <action>
实现认证前端（按 CONTEXT 锁定决策）：
- Setup 页: 表单 username、password、confirm；校验规则（username 3-50，password 8+，confirm 一致）；提交到 POST /api/setup；成功后跳转 /
- Login 页: 居中极简风格（纯色背景 + 居中登录卡片，Vercel Dashboard 风格）；表单 username、password、「记住我」复选框；失败显示「用户名或密码错误」；提交到 POST /api/login
- 路由: /setup → Setup，/login → Login，/ → 需认证的 Dashboard（暂占位或重定向到 /dashboard）；未登录访问 / 重定向 /login；已登录访问 /setup、/login 重定向 /
- 使用 React Router v7、fetch 调用 API；credentials: 'include' 携带 cookie
  </action>
  <verify>访问 /setup 可完成首次设置；访问 /login 可登录；登录后访问 / 不重定向到 /login</verify>
  <done>Setup、Login 页面可用，路由与 session 联动正确</done>
</task>

</tasks>

<verification>
- 首次访问重定向到 /setup，完成设置后跳转 /
- 登出后访问 / 重定向 /login
- 登录成功后可访问受保护路由
</verification>

<success_criteria>
1. 管理员首次部署必须通过 Setup 设置账号，无默认密码
2. 登录后 Session 7 天（勾选「记住我」）
3. 登录页居中卡片、Vercel 风格
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
