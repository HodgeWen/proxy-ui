---
phase: 02-inbound-management
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - internal/core/generator.go
autonomous: true
user_setup: []

must_haves:
  truths:
    - "ConfigGenerator produces valid sing-box JSON from DB inbounds"
    - "Generated config includes log, inbounds, outbounds, route"
  artifacts:
    - path: internal/core/generator.go
      provides: ConfigGenerator that reads inbounds from DB
      contains: "func.*Generate"
  key_links:
    - from: internal/core/generator.go
      to: internal/db/inbound.go
      via: db.ListInbounds
      pattern: "ListInbounds|Find.*Inbound"
---

<objective>
Implement ConfigGenerator that reads inbounds from DB and outputs full sing-box JSON.

Purpose: DB-first flow — config is generated from DB, not edited raw. ApplyConfig + Restart use this output.
Output: internal/core/generator.go with Generate() and inboundToSingBox()
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-inbound-management/02-RESEARCH.md
@internal/core/config.go
@internal/db/inbound.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: ConfigGenerator skeleton and VLESS mapping</name>
  <files>internal/core/generator.go</files>
  <action>
Create internal/core/generator.go.

ConfigGenerator struct with Generate() ([]byte, error):
1. db.ListInbounds()
2. Build inbounds slice: for each Inbound, call inboundToSingBox() to produce map[string]any
3. Full config: map with keys "log", "inbounds", "outbounds", "route"
   - log: {"level": "info"}
   - inbounds: []map[string]any from step 2
   - outbounds: [{"type":"direct","tag":"direct"}, {"type":"block","tag":"block"}]
   - route: {"rules": []}
4. json.MarshalIndent

inboundToSingBox(ib *db.Inbound) map[string]any:
- For protocol "vless": type "vless", tag, listen, listen_port from model; users from config_json or [] if empty; tls and transport from config_json (omit if disabled/empty)
- VLESS tls: if config has tls.enabled; reality vs cert per RESEARCH
- VLESS transport: omit = TCP; ws/grpc/http per RESEARCH
- Follow sing-box JSON structure from 02-RESEARCH.md code examples
</action>
  <verify>go build ./internal/core/...</verify>
  <done>Generate() returns valid JSON with inbounds array</done>
</task>

<task type="auto">
  <name>Task 2: Hysteria2 inbound mapping</name>
  <files>internal/core/generator.go</files>
  <action>
Extend inboundToSingBox for protocol "hysteria2":

Per RESEARCH: Hysteria2 uses type "hysteria2", tag, listen, listen_port, up_mbps, down_mbps, obfs{}, users[], tls{}. TLS is REQUIRED (no "无 TLS" option).

From config_json extract: up_mbps, down_mbps, obfs (type salamander + password), tls. Omit up_mbps/down_mbps if zero or not set. users: [] for Phase 2.

Ensure tls object has enabled:true, server_name, certificate_path, key_path. No reality for Hysteria2.
</action>
  <verify>go build ./internal/core/...</verify>
  <done>Both VLESS and Hysteria2 inbounds produce valid sing-box JSON</done>
</task>

</tasks>

<verification>
- go build ./...
- With at least one Inbound in DB, Generate() output passes `sing-box check -c /dev/stdin` when piped
</verification>

<success_criteria>
- ConfigGenerator reads from DB, produces full sing-box config
- VLESS and Hysteria2 structures match official sing-box schema
</success_criteria>

<output>
After completion, create `.planning/phases/02-inbound-management/02-02-SUMMARY.md`
</output>
