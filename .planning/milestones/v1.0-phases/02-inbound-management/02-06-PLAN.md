---
phase: 02-inbound-management
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - web/src/components/inbounds/InboundFormModal.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "用户可编辑已有入站配置（含 Hysteria2）"
    - "表单字段有智能默认值，且每个字段旁有 info 图标悬浮说明"
  artifacts:
    - path: "web/src/components/inbounds/InboundFormModal.tsx"
      provides: "Inbound add/edit form with protocol sync and field tooltips"
      key_sections:
        - "useEffect: setProtocol when inbound loads"
        - "协议 FieldLabel with tooltip"
        - "TLS 类型 FieldLabel with tooltip"
  key_links:
    - from: "InboundFormModal useEffect"
      to: "protocol state"
      via: "setProtocol(inbound.protocol)"
      pattern: "setProtocol.*inbound\\.protocol"
---

<objective>
Close Phase 2 verification gaps in InboundFormModal: (1) protocol state not syncing when editing Hysteria2 inbound; (2) protocol and TLS type fields missing info tooltips.

Purpose: Achieve full Phase 2 verification score (6/6) and satisfy INB-03, INB-09.
Output: InboundFormModal.tsx with protocol sync fix and FieldLabel for protocol/TLS type.
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-inbound-management/02-VERIFICATION.md
@web/src/components/inbounds/InboundFormModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sync protocol state when inbound loads</name>
  <files>web/src/components/inbounds/InboundFormModal.tsx</files>
  <action>
    In the useEffect (around lines 287–349) that runs when `inbound` or `open` changes:
    - When `inbound` exists, add `setProtocol(inbound.protocol === "hysteria2" ? "hysteria2" : "vless")` at the start of the `if (inbound)` block, before the form reset logic.
    - When `inbound` is null (add mode), add `setProtocol("vless")` in the `else` block to reset protocol when modal opens for add.
    Gap reason: protocol state was initialized from `inbound?.protocol` only at mount; when inbound is loaded asynchronously (e.g. after edit button click), useEffect resets forms but never updates protocol, so Hysteria2 form renders VLESS fields instead.
  </action>
  <verify>
    Add a Hysteria2 inbound, click Edit. Form should show Hysteria2 protocol and Hysteria2-specific fields (上行/下行带宽, Obfs). NOT VLESS fields.
  </verify>
  <done>
    Editing a Hysteria2 inbound displays the Hysteria2 form section with correct protocol.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add FieldLabel for protocol and TLS type fields</name>
  <files>web/src/components/inbounds/InboundFormModal.tsx</files>
  <action>
    Replace plain Label with FieldLabel for two fields:
    1. Protocol (Line ~407): Replace `<Label htmlFor="protocol">协议</Label>` with `<FieldLabel label="协议" tooltip="入站协议类型。VLESS 基于 XTLS，Hysteria2 基于 QUIC。选择后表单字段会切换。典型值：VLESS 或 Hysteria2。" htmlFor="protocol" />`
    2. TLS type (Line ~516): Replace `<Label>TLS 类型</Label>` with `<FieldLabel label="TLS 类型" tooltip="TLS 模式。无 TLS 表示明文；TLS 使用证书；Reality 使用 Reality 协议伪装。选择后下方显示对应配置字段。" />`
    Use existing FieldLabel component (lines 89–113). No htmlFor on TLS type Select since it uses SelectTrigger without id.
  </action>
  <verify>
    Hover over protocol and TLS type fields — info icon should appear and tooltip should show on hover.
  </verify>
  <done>
    Protocol and TLS type fields display info icon with悬浮 tooltip on hover.
  </done>
</task>

</tasks>

<verification>
- Edit Hysteria2 inbound: modal shows Hysteria2 form (not VLESS).
- Protocol and TLS type fields have info icon and tooltip.
</verification>

<success_criteria>
- Gap 1: protocol sync — closed
- Gap 2: info tooltips for protocol and TLS type — closed
</success_criteria>

<output>
After completion, create `.planning/phases/02-inbound-management/02-06-SUMMARY.md`
</output>
